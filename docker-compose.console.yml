services:
  console:
    build:
      context: ./console/backend
      dockerfile: Dockerfile
    container_name: minecraft-console
    restart: unless-stopped
    ports:
      - "3001:3001"
    environment:
      # Console Configuration
      - CONSOLE_PORT=3001
      - API_PORT=3001
      # NODE_ENV controls cookie security:
      # - production: secure cookies (HTTPS/SSL required)
      # - development/test: non-secure cookies (HTTP allowed)
      # Override with COOKIE_SECURE=false for HTTP testing in any environment
      - NODE_ENV=${NODE_ENV:-production}
      - COOKIE_SECURE=${COOKIE_SECURE:-}
      - SESSION_SECRET=${SESSION_SECRET:-change-this-to-a-secure-random-string}

      # Admin Account
      - ADMIN_USERNAME=${ADMIN_USERNAME:-admin}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-change-this-secure-password}

      # RCON Configuration
      - RCON_HOST=${RCON_HOST:-minecraft-server}
      - RCON_PORT=${RCON_PORT:-25575}
      - RCON_PASSWORD=${RCON_PASSWORD:-your-secure-rcon-password}

      # Minecraft Server
      - MC_CONTAINER_NAME=${MC_CONTAINER_NAME:-minecraft-server}
      - MC_SERVER_DIR=/data

      # Security
      - CSRF_SECRET=${CSRF_SECRET:-change-this-to-a-secure-csrf-secret}
      - RATE_LIMIT_WINDOW_MS=${RATE_LIMIT_WINDOW_MS:-900000}
      - RATE_LIMIT_MAX_ATTEMPTS=${RATE_LIMIT_MAX_ATTEMPTS:-5}

      # Optional: Path overrides (defaults work in Docker, customize if needed)
      # - SERVER_PROPS_PATH=/path/to/server.properties
      # - LOGS_DIR=/data/logs
      # - BACKUPS_DIR=/backups
      # - BACKUP_SCRIPT_PATH=/app/backup.sh

    volumes:
      # Mount Docker socket to control containers
      - /var/run/docker.sock:/var/run/docker.sock

      # Mount console config
      - ./console/backend/config:/app/config

      # Mount server data for file access
      - ./data:/data:ro

      # Mount backup script
      - ./backup.sh:/app/backup.sh:ro

    networks:
      - minecraft-network

    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

networks:
  minecraft-network:
    driver: bridge

# Notes:
# 1. REQUIRED: Set secure values in .env file for:
#    - SESSION_SECRET (generate with: openssl rand -hex 32)
#    - CSRF_SECRET (generate with: openssl rand -base64 32)
#    - ADMIN_PASSWORD (generate with: openssl rand -base64 32)
#    - RCON_PASSWORD (must match Minecraft server)
#    The console will NOT start without ADMIN_PASSWORD and CSRF_SECRET set!
#
# 2. The console needs access to Docker socket to control the Minecraft container
#
# 3. To start the console:
#    docker compose -f docker-compose.console.yml up -d
#
# 4. Access the console at http://your-server-ip:3001/console
#    API available at: http://your-server-ip:3001/api/plugins
#
# 5. For production, use Nginx reverse proxy with SSL (see nginx/console.conf)
#
# 6. The server binds to 0.0.0.0:3001 inside the container to accept connections
#    from all interfaces. Port 3001 is exposed and mapped for external access.
#
# 7. Cookie Security Configuration:
#    - Production (NODE_ENV=production): secure cookies enabled (HTTPS/SSL required)
#    - Development/Test: Set NODE_ENV=development or COOKIE_SECURE=false for HTTP testing
#    - CI/Diagnostics: Use COOKIE_SECURE=false to allow plain HTTP authentication
#    - Without proper configuration, session cookies won't be sent over HTTP, breaking authentication
