services:
  # Redis service for persistent session storage
  redis:
    image: redis:7-alpine
    container_name: minecraft-console-redis
    restart: unless-stopped
    command: redis-server --appendonly yes
    volumes:
      # Persist Redis data for session recovery across restarts
      - redis-data:/data
    networks:
      - minecraft-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 10s

  console:
    build:
      context: ./console/backend
      dockerfile: Dockerfile
    container_name: minecraft-console
    restart: unless-stopped
    ports:
      - "3001:3001"
    environment:
      # Console Configuration
      - CONSOLE_PORT=3001
      - API_PORT=3001
      # NODE_ENV controls cookie security:
      # - production: secure cookies (HTTPS/SSL required)
      # - development/test: non-secure cookies (HTTP allowed)
      # Override with COOKIE_SECURE=false for HTTP testing in any environment
      - NODE_ENV=${NODE_ENV:-production}
      - COOKIE_SECURE=${COOKIE_SECURE:-}
      - SESSION_SECRET=${SESSION_SECRET:-change-this-to-a-secure-random-string}

      # Redis Configuration (for persistent sessions)
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}

      # Admin Account
      - ADMIN_USERNAME=${ADMIN_USERNAME:-admin}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-change-this-secure-password}

      # RCON Configuration
      - RCON_HOST=${RCON_HOST:-minecraft-server}
      - RCON_PORT=${RCON_PORT:-25575}
      - RCON_PASSWORD=${RCON_PASSWORD:-your-secure-rcon-password}

      # Minecraft Server
      - MC_CONTAINER_NAME=${MC_CONTAINER_NAME:-minecraft-server}
      - MC_SERVER_DIR=/data

      # Security
      - CSRF_SECRET=${CSRF_SECRET:-change-this-to-a-secure-csrf-secret}
      - RATE_LIMIT_WINDOW_MS=${RATE_LIMIT_WINDOW_MS:-900000}
      - RATE_LIMIT_MAX_ATTEMPTS=${RATE_LIMIT_MAX_ATTEMPTS:-5}

      # Optional: Path overrides (defaults work in Docker, customize if needed)
      # - SERVER_PROPS_PATH=/path/to/server.properties
      # - LOGS_DIR=/data/logs
      # - BACKUPS_DIR=/backups
      # - BACKUP_SCRIPT_PATH=/app/backup.sh

    volumes:
      # Mount Docker socket to control containers
      - /var/run/docker.sock:/var/run/docker.sock

      # Mount console config
      - ./console/backend/config:/app/config

      # Mount server data for file access
      - ./data:/data:ro

      # Mount backup script
      - ./backup.sh:/app/backup.sh:ro

    networks:
      - minecraft-network

    depends_on:
      redis:
        condition: service_healthy

    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

volumes:
  redis-data:
    driver: local

networks:
  minecraft-network:
    driver: bridge

# Notes:
# 1. REQUIRED: Set secure values in .env file for:
#    - SESSION_SECRET (generate with: openssl rand -hex 32)
#    - CSRF_SECRET (generate with: openssl rand -base64 32)
#    - ADMIN_PASSWORD (generate with: openssl rand -base64 32)
#    - RCON_PASSWORD (must match Minecraft server)
#    The console will NOT start without ADMIN_PASSWORD and CSRF_SECRET set!
#
# 2. The console needs access to Docker socket to control the Minecraft container
#
# 3. To start the console:
#    docker compose -f docker-compose.console.yml up -d
#
# 4. Access the console at http://your-server-ip:3001/console
#    API available at: http://your-server-ip:3001/api/plugins
#
# 5. For production, use Nginx reverse proxy with SSL (see nginx/console.conf)
#
# 6. The server binds to 0.0.0.0:3001 inside the container to accept connections
#    from all interfaces. Port 3001 is exposed and mapped for external access.
#
# 7. Cookie Security Configuration:
#    IMPORTANT: Session and CSRF cookies use the 'secure' flag based on environment.
#    
#    Secure cookies (secure=true) are ONLY sent over HTTPS:
#    - Required for production security
#    - Prevents cookie theft over unencrypted connections
#    - But BREAKS all HTTP testing (local dev, CI, curl, diagnostics)
#    
#    When secure=true with HTTP requests:
#    - Browsers/curl do NOT send the cookie to the server
#    - Server sees no cookies, creates new session every request
#    - Authentication always fails (session not persisted)
#    - CSRF tokens never match (different sessions)
#    
#    Configuration options:
#    a) Production with HTTPS/SSL (recommended):
#       - NODE_ENV=production (secure=true automatically)
#       - Requires reverse proxy with SSL (Nginx/Caddy)
#       
#    b) Development/Testing with HTTP:
#       - NODE_ENV=development or NODE_ENV=test (secure=false automatically)
#       - Works with plain HTTP on localhost
#       
#    c) Override for HTTP testing in any environment:
#       - COOKIE_SECURE=false (forces secure=false)
#       - Use for CI/CD, curl diagnostics, HTTP testing
#       - Example: Production deployment but testing API via HTTP before SSL is configured
#    
#    How to test:
#    - Check backend logs for "[Session] Cookie configuration" and "[CSRF] Cookie configuration"
#    - Both should show "secure: false" for HTTP or "secure: true" for HTTPS
#    - Test with curl using -c/-b flags to save/send cookies
#    
#    Example curl workflow for HTTP testing:
#      # Login and save cookies
#      curl -c cookies.txt -X POST http://localhost:3001/api/login \
#        -H "Content-Type: application/json" \
#        -d '{"username":"admin","password":"your-password"}'
#      
#      # Get CSRF token (uses saved cookies, saves new CSRF cookie)
#      curl -c cookies.txt -b cookies.txt http://localhost:3001/api/csrf-token
#      
#      # Make authenticated request with CSRF token
#      curl -b cookies.txt -H "CSRF-Token: <token>" http://localhost:3001/api/plugins
#    
#    See docs/SESSION-CSRF-DEBUG-IMPLEMENTATION.md for troubleshooting details.
#    Without proper configuration, session cookies won't be sent over HTTP, breaking authentication
