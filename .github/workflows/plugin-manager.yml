name: Plugin Manager

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        default: 'install'
        options:
          - install
          - update
          - force-reinstall
          - discover
          - discover-and-install
          - dry-run
      debug_mode:
        description: 'Enable verbose debug output'
        required: false
        type: boolean
        default: false
      wait_for_rate_limit:
        description: 'Wait for GitHub rate limit reset instead of failing'
        required: false
        type: boolean
        default: true
      max_retries:
        description: 'Maximum retry attempts for failed plugins'
        required: false
        type: number
        default: 3
      download_timeout:
        description: 'Download timeout in seconds'
        required: false
        type: number
        default: 300
      plugin_filter:
        description: 'Specific plugin name to install/update (leave empty for all)'
        required: false
        type: string
        default: ''
      restart_server:
        description: 'Restart Minecraft server after deployment'
        required: false
        type: boolean
        default: true
      backup_before_deploy:
        description: 'Backup existing plugins before deploying'
        required: false
        type: boolean
        default: true

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  CONNECTION_TIMEOUT: 15
  DOWNLOAD_TIMEOUT: ${{ inputs.download_timeout }}
  SERVER_PLUGINS_PATH: /home/deploy/minecraft-server/plugins

jobs:
  download-plugins:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      plugins_downloaded: ${{ steps.check_artifacts.outputs.has_plugins }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq
      
      - name: Validate plugins.json
        run: |
          if [ ! -f "plugins.json" ]; then
            echo "Error: plugins.json not found"
            exit 1
          fi
          
          # Basic JSON validation
          if ! jq empty plugins.json 2>/dev/null; then
            echo "Error: plugins.json is not valid JSON"
            exit 1
          fi
          
          echo "✓ plugins.json is valid"
      
      - name: Filter plugins if specified
        if: inputs.plugin_filter != ''
        run: |
          echo "Filtering for plugin: ${{ inputs.plugin_filter }}"
          
          # Create filtered config with only the specified plugin
          jq --arg name "${{ inputs.plugin_filter }}" \
            '.plugins = [.plugins[] | select(.name == $name)]' \
            plugins.json > plugins.json.filtered
          
          # Check if plugin was found
          PLUGIN_COUNT=$(jq '.plugins | length' plugins.json.filtered)
          if [ "$PLUGIN_COUNT" -eq 0 ]; then
            echo "Error: Plugin '${{ inputs.plugin_filter }}' not found in plugins.json"
            exit 1
          fi
          
          mv plugins.json.filtered plugins.json
          echo "✓ Filtered to plugin: ${{ inputs.plugin_filter }}"
      
      - name: Run install-plugins.sh
        run: |
          # Build command with flags based on action
          CMD="./install-plugins.sh"
          
          case "${{ inputs.action }}" in
            install)
              # No extra flags for install
              ;;
            update)
              CMD="$CMD --update"
              ;;
            force-reinstall)
              CMD="$CMD --force"
              ;;
            discover)
              CMD="$CMD --discover"
              ;;
            discover-and-install)
              CMD="$CMD --discover --install"
              ;;
            dry-run)
              CMD="$CMD --dry-run"
              ;;
          esac
          
          # Add conditional flags
          if [ "${{ inputs.debug_mode }}" = "true" ]; then
            CMD="$CMD --debug"
          fi
          
          if [ "${{ inputs.wait_for_rate_limit }}" = "true" ]; then
            CMD="$CMD --wait-for-rate-limit"
          fi
          
          # Add numeric parameters
          CMD="$CMD --max-retries ${{ inputs.max_retries }}"
          CMD="$CMD --timeout ${{ inputs.download_timeout }}"
          
          echo "Executing: $CMD"
          $CMD
      
      - name: Check if plugins were downloaded
        id: check_artifacts
        run: |
          if [ -d "plugins" ] && ls plugins/*.jar 1> /dev/null 2>&1; then
            echo "has_plugins=true" >> $GITHUB_OUTPUT
            echo "✓ Plugins downloaded successfully"
          else
            echo "has_plugins=false" >> $GITHUB_OUTPUT
            echo "No plugins downloaded"
          fi
      
      - name: Upload plugins artifact
        if: steps.check_artifacts.outputs.has_plugins == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: minecraft-plugins
          path: plugins/*.jar
          retention-days: 1
      
      - name: Upload installation log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: installation-log
          path: plugin-install.log
          retention-days: 7

  deploy-to-server:
    needs: download-plugins
    if: |
      needs.download-plugins.outputs.plugins_downloaded == 'true' &&
      inputs.action != 'dry-run' &&
      inputs.action != 'discover'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Download plugin artifacts
        uses: actions/download-artifact@v4
        with:
          name: minecraft-plugins
          path: plugins
      
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
      
      - name: Backup existing plugins
        if: inputs.backup_before_deploy
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
        run: |
          ssh ${SERVER_USER}@${SERVER_HOST} << 'EOF'
            PLUGINS_PATH="${{ env.SERVER_PLUGINS_PATH }}"
            BACKUP_DIR="${PLUGINS_PATH}/backups/backup_$(date +%Y%m%d_%H%M%S)"
            
            # Create backup directory
            mkdir -p "$BACKUP_DIR"
            
            # Backup existing jar files
            if ls ${PLUGINS_PATH}/*.jar 1> /dev/null 2>&1; then
              echo "Backing up existing plugins to $BACKUP_DIR"
              cp ${PLUGINS_PATH}/*.jar "$BACKUP_DIR/" 2>/dev/null || true
              echo "✓ Backup completed"
            else
              echo "No existing plugins to backup"
            fi
            
            # Keep only last 5 backups
            BACKUP_BASE="${PLUGINS_PATH}/backups"
            if [ -d "$BACKUP_BASE" ]; then
              BACKUP_COUNT=$(ls -1d ${BACKUP_BASE}/backup_* 2>/dev/null | wc -l)
              if [ "$BACKUP_COUNT" -gt 5 ]; then
                echo "Cleaning up old backups (keeping last 5)..."
                ls -1td ${BACKUP_BASE}/backup_* | tail -n +6 | xargs rm -rf
                echo "✓ Cleanup completed"
              fi
            fi
          EOF
      
      - name: Deploy plugins to server
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
        run: |
          # Create plugins directory if it doesn't exist
          ssh ${SERVER_USER}@${SERVER_HOST} "mkdir -p ${{ env.SERVER_PLUGINS_PATH }}"
          
          # Deploy plugins
          echo "Deploying plugins to server..."
          scp plugins/*.jar ${SERVER_USER}@${SERVER_HOST}:${{ env.SERVER_PLUGINS_PATH }}/
          
          echo "✓ Plugins deployed successfully"
      
      - name: Set file permissions
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
        run: |
          ssh ${SERVER_USER}@${SERVER_HOST} << 'EOF'
            chmod 644 ${{ env.SERVER_PLUGINS_PATH }}/*.jar
            echo "✓ File permissions set to 644"
          EOF
      
      - name: Restart Minecraft server
        if: inputs.restart_server
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
        run: |
          ssh ${SERVER_USER}@${SERVER_HOST} << 'EOF'
            echo "Restarting Minecraft server..."
            sudo systemctl restart minecraft.service
            
            # Wait for service to start with retries
            MAX_ATTEMPTS=6
            ATTEMPT=1
            while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
              sleep 5
              if systemctl is-active --quiet minecraft.service; then
                echo "✓ Minecraft server restarted successfully"
                exit 0
              fi
              echo "Waiting for server to start (attempt $ATTEMPT/$MAX_ATTEMPTS)..."
              ATTEMPT=$((ATTEMPT + 1))
            done
            
            echo "⚠ Warning: Server may not have started properly"
            sudo systemctl status minecraft.service --no-pager || true
            exit 1
          EOF
      
      - name: Cleanup SSH key
        if: always()
        run: |
          if [ -f ~/.ssh/id_rsa ]; then
            rm -f ~/.ssh/id_rsa
          fi

  summary:
    needs: [download-plugins, deploy-to-server]
    if: always()
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Download installation log
        if: always()
        uses: actions/download-artifact@v4
        with:
          name: installation-log
          path: .
        continue-on-error: true
      
      - name: Generate summary
        if: always()
        run: |
          echo "# Plugin Manager Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Input settings
          echo "## Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Action | \`${{ inputs.action }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Debug Mode | ${{ inputs.debug_mode }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Wait for Rate Limit | ${{ inputs.wait_for_rate_limit }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Max Retries | ${{ inputs.max_retries }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Download Timeout | ${{ inputs.download_timeout }}s |" >> $GITHUB_STEP_SUMMARY
          echo "| Plugin Filter | ${{ inputs.plugin_filter || 'All plugins' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Restart Server | ${{ inputs.restart_server }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Backup Before Deploy | ${{ inputs.backup_before_deploy }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Job results
          echo "## Job Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Download Plugins | ${{ needs.download-plugins.result }} |" >> $GITHUB_STEP_SUMMARY
          
          # Deploy job may be skipped, show appropriate status
          DEPLOY_STATUS="${{ needs.deploy-to-server.result }}"
          if [ -z "$DEPLOY_STATUS" ]; then
            DEPLOY_STATUS="skipped"
          fi
          echo "| Deploy to Server | $DEPLOY_STATUS |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Installation log (last 30 lines)
          if [ -f "plugin-install.log" ]; then
            echo "## Installation Log (Last 30 Lines)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -n 30 plugin-install.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "## Installation Log" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "⚠ Installation log not available" >> $GITHUB_STEP_SUMMARY
          fi
