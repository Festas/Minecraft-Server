name: Server Diagnostics

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Diagnostic action to perform'
        required: true
        default: 'full-diagnostics'
        type: choice
        options:
          - full-diagnostics
          - check-ports
          - list-containers
          - list-processes
          - free-minecraft-port
          - cleanup-containers
          - check-systemd-services
          - test-dns-connectivity

jobs:
  diagnostics:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Validate required secrets
        run: |
          MISSING_SECRETS=()

          if [ -z "${{ secrets.SERVER_HOST }}" ]; then
            MISSING_SECRETS+=("SERVER_HOST")
          fi
          if [ -z "${{ secrets.SERVER_USER }}" ]; then
            MISSING_SECRETS+=("SERVER_USER")
          fi
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            MISSING_SECRETS+=("SSH_PRIVATE_KEY")
          fi

          if [ ${#MISSING_SECRETS[@]} -gt 0 ]; then
            echo "::error::Missing required secrets: ${MISSING_SECRETS[*]}"
            exit 1
          fi

          echo "âœ“ All required secrets are configured"

      - name: Run diagnostics
        uses: appleboy/ssh-action@v1.2.4
        env:
          ACTION: ${{ github.event.inputs.action }}
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: ACTION
          command_timeout: 10m
          script: |
            # Define deployment directory
            DEPLOY_DIR="/home/deploy/minecraft-server"

            echo "=============================================="
            echo "Server Diagnostics - $(date)"
            echo "Action: ${ACTION}"
            echo "=============================================="
            echo ""

            case "${ACTION}" in
              full-diagnostics)
                echo "=== System Information ==="
                uname -a
                echo ""

                echo "=== Disk Space ==="
                df -h /home /home/deploy 2>/dev/null
                echo ""

                echo "=== Memory Usage ==="
                free -h
                echo ""

                echo "=== Docker Version ==="
                docker --version
                docker compose version
                echo ""

                echo "=== All Docker Containers ==="
                docker ps -a --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}\t{{.Image}}"
                echo ""

                echo "=== Docker Networks ==="
                docker network ls
                echo ""

                echo "=== Docker Volumes ==="
                docker volume ls
                echo ""

                echo "=== Port 25565 Usage ==="
                echo "Checking what's using port 25565..."
                sudo ss -tlnp | grep 25565 || echo "Port 25565 is FREE"
                echo ""

                echo "=== Port 25575 (RCON) Usage ==="
                sudo ss -tlnp | grep 25575 || echo "Port 25575 is FREE"
                echo ""

                echo "=== Java/Minecraft Processes ==="
                ps aux | grep -E "java|minecraft|paper" | grep -v grep || echo "No Java/Minecraft processes found"
                echo ""

                echo "=== Minecraft Server Directory ==="
                ls -la "$DEPLOY_DIR" 2>/dev/null || echo "Directory does not exist"
                echo ""

                echo "=== Docker Compose File (if exists) ==="
                cat "$DEPLOY_DIR/docker-compose.yml" 2>/dev/null || echo "No docker-compose.yml found"
                echo ""

                echo "=== Minecraft Container Logs (last 50 lines) ==="
                docker logs minecraft-server --tail=50 2>&1 || echo "No minecraft-server container logs available"
                echo ""

                echo "=============================================="
                echo "Diagnostics complete!"
                echo "=============================================="
                ;;

              check-ports)
                echo "=== Checking All Relevant Ports ==="
                echo ""
                echo "Port 25565 (Minecraft Game):"
                sudo ss -tlnp | grep 25565 || echo "  â†’ FREE"
                echo ""
                echo "Port 25575 (RCON):"
                sudo ss -tlnp | grep 25575 || echo "  â†’ FREE"
                echo ""
                echo "Port 80 (HTTP):"
                sudo ss -tlnp | grep :80 | head -5 || echo "  â†’ FREE"
                echo ""
                echo "Port 443 (HTTPS):"
                sudo ss -tlnp | grep :443 | head -5 || echo "  â†’ FREE"
                echo ""
                echo "=== All Listening Ports ==="
                sudo ss -tlnp | head -30
                ;;

              list-containers)
                echo "=== All Docker Containers ==="
                docker ps -a --format "table {{.ID}}\t{{.Names}}\t{{.Status}}\t{{.Ports}}\t{{.Image}}"
                echo ""
                echo "=== Container Details ==="
                for container in $(docker ps -a --format "{{.Names}}"); do
                  echo "--- $container ---"
                  docker inspect "$container" --format \
                    'Status: {{.State.Status}}, Health: {{.State.Health.Status}}'
                  echo "Ports:"
                  docker port "$container" 2>/dev/null || echo "  No ports exposed"
                done
                ;;

              list-processes)
                echo "=== Java Processes ==="
                ps aux | grep java | grep -v grep || echo "No Java processes"
                echo ""
                echo "=== All User Processes ==="
                ps aux --sort=-%mem | head -20
                ;;

              free-minecraft-port)
                echo "=== Freeing Port 25565 ==="
                echo ""

                echo "Step 1: Checking what's using port 25565..."
                PORT_INFO=$(sudo ss -tlnp | grep 25565)
                if [ -z "$PORT_INFO" ]; then
                  echo "âœ“ Port 25565 is already free!"
                  exit 0
                fi
                echo "$PORT_INFO"
                echo ""

                echo "Step 2: Checking for and disabling old systemd services..."
                MINECRAFT_SERVICES=$(systemctl list-unit-files | grep -i minecraft | awk '{print $1}' || true)
                if [ -n "$MINECRAFT_SERVICES" ]; then
                  echo "Found systemd minecraft services:"
                  echo "$MINECRAFT_SERVICES"
                  for service in $MINECRAFT_SERVICES; do
                    echo "Disabling and stopping $service..."
                    sudo systemctl disable --now "$service" 2>/dev/null || true
                  done
                  sleep 2
                else
                  echo "No systemd minecraft services found"
                fi
                echo ""

                echo "Step 3: Looking for bare-metal Java/Minecraft processes..."
                JAVA_PROCS=$(ps aux | grep -E "paper|server.jar|minecraft" | grep java | grep -v grep)
                if [ -n "$JAVA_PROCS" ]; then
                  echo "Found Java/Minecraft processes:"
                  echo "$JAVA_PROCS"
                  echo ""
                  echo "Killing Java/Minecraft processes..."
                  sudo pkill -f "paper" || true
                  sudo pkill -f "server.jar" || true
                  sleep 2
                fi

                echo "Step 4: Checking for stuck Docker containers..."
                STUCK_CONTAINER=$(docker ps -a --filter "name=minecraft-server" --format "{{.Names}}")
                if [ -n "$STUCK_CONTAINER" ]; then
                  echo "Found container: $STUCK_CONTAINER"
                  echo "Stopping and removing..."
                  docker stop minecraft-server 2>/dev/null || true
                  docker rm -f minecraft-server 2>/dev/null || true
                  sleep 2
                fi

                echo "Step 5: Final check..."
                if sudo ss -tlnp | grep 25565; then
                  echo "âš  Warning: Port 25565 is still in use!"
                  echo "You may need to manually investigate."
                  exit 1
                else
                  echo "âœ“ Port 25565 is now FREE!"
                fi
                ;;

              cleanup-containers)
                echo "=== Cleaning Up Docker Resources ==="
                echo ""

                echo "Step 1: Stopping minecraft-server container..."
                docker stop minecraft-server 2>/dev/null || echo "Container not running"

                echo "Step 2: Removing minecraft-server container..."
                docker rm -f minecraft-server 2>/dev/null || echo "Container not found"

                echo "Step 3: Removing any dangling containers..."
                docker container prune -f

                echo "Step 4: Removing unused images..."
                docker image prune -f

                echo "Step 5: Final status..."
                echo ""
                echo "Remaining containers:"
                docker ps -a --format "table {{.Names}}\t{{.Status}}"
                echo ""
                echo "âœ“ Cleanup complete!"
                ;;

              check-systemd-services)
                echo "=== Checking for Old Systemd Minecraft Services ==="
                echo ""

                echo "Step 1: Looking for minecraft-related systemd units..."
                MINECRAFT_SERVICES=$(systemctl list-unit-files | grep -i minecraft | awk '{print $1}' || true)

                if [ -z "$MINECRAFT_SERVICES" ]; then
                  echo "âœ“ No minecraft systemd services found"
                else
                  echo "Found minecraft systemd services:"
                  echo "$MINECRAFT_SERVICES"
                  echo ""

                  echo "Step 2: Checking if any are enabled or active..."
                  for service in $MINECRAFT_SERVICES; do
                    echo "--- $service ---"
                    systemctl status "$service" --no-pager || true
                    echo ""
                  done

                  echo "âš  WARNING: Old systemd minecraft services detected!"
                  echo "These should be disabled to prevent port conflicts on reboot."
                  echo ""
                  echo "To disable them, run this workflow with the action: free-minecraft-port"
                  echo "Or manually run: sudo systemctl disable --now minecraft.service"
                fi

                echo ""
                echo "Step 3: Checking for other Java processes..."
                ps aux | grep -E "paper|server.jar|minecraft" | grep java | grep -v grep \
                  || echo "âœ“ No Java/Minecraft processes running"

                echo ""
                echo "Step 4: Checking systemd timers..."
                systemctl list-timers | grep -i minecraft || echo "âœ“ No minecraft timers found"
                ;;

              test-dns-connectivity)
                echo "=== Testing DNS Connectivity ==="
                echo ""

                echo "Step 1: Check system DNS configuration..."
                echo "--- /etc/resolv.conf ---"
                cat /etc/resolv.conf
                echo ""

                echo "Step 2: Test DNS resolution from host..."
                echo "Testing fill.papermc.io..."
                if dig fill.papermc.io +short; then
                  echo "âœ“ Host can resolve fill.papermc.io"
                else
                  echo "âš  Host cannot resolve fill.papermc.io"
                fi
                echo ""

                echo "Step 3: Test DNS resolution with Google DNS..."
                echo "Testing fill.papermc.io using 8.8.8.8..."
                if dig @8.8.8.8 fill.papermc.io +short; then
                  echo "âœ“ Google DNS (8.8.8.8) can resolve fill.papermc.io"
                else
                  echo "âš  Google DNS cannot resolve fill.papermc.io"
                fi
                echo ""

                echo "Step 4: Test DNS resolution with Cloudflare DNS..."
                echo "Testing fill.papermc.io using 1.1.1.1..."
                if dig @1.1.1.1 fill.papermc.io +short; then
                  echo "âœ“ Cloudflare DNS (1.1.1.1) can resolve fill.papermc.io"
                else
                  echo "âš  Cloudflare DNS cannot resolve fill.papermc.io"
                fi
                echo ""

                echo "Step 5: Test connectivity to PaperMC..."
                echo "Testing HTTPS connection to fill.papermc.io..."
                if curl -I https://fill.papermc.io --connect-timeout 5 --max-time 10; then
                  echo "âœ“ Can connect to fill.papermc.io"
                else
                  echo "âš  Cannot connect to fill.papermc.io"
                fi
                echo ""

                echo "Step 6: Check if systemd-resolved is being used..."
                if systemctl is-active systemd-resolved >/dev/null 2>&1; then
                  echo "âœ“ systemd-resolved is active"
                  echo "Note: Docker containers cannot use 127.0.0.53 directly"
                  echo "This is why we configure explicit DNS servers in docker-compose.yml"
                else
                  echo "systemd-resolved is not active"
                fi
                ;;

              *)
                echo "Unknown action: ${ACTION}"
                exit 1
                ;;
            esac

      - name: Summary
        if: always()
        run: |
          ACTION="${{ github.event.inputs.action }}"
          {
            echo "## Server Diagnostics Complete ðŸ”"
            echo ""
            echo "**Action performed:** \`${ACTION}\`"
            echo ""
            echo "Check the workflow logs above for detailed output."
            echo ""
            if [ "$ACTION" = "free-minecraft-port" ]; then
              echo "### Next Steps"
              echo "If the port was freed successfully, you can now run the"
              echo "**Deploy Minecraft Server Container** workflow."
            fi
          } >> "$GITHUB_STEP_SUMMARY"
