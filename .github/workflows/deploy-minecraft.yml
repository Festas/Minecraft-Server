name: Deploy Minecraft Server Container

on:
  workflow_dispatch:  # Manual trigger only for safety
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'deploy'
        type: choice
        options:
          - deploy
          - restart
          - stop
          - start
          - update
          - logs

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Validate required secrets
        run: |
          MISSING_SECRETS=()

          if [ -z "${{ secrets.SERVER_HOST }}" ]; then
            MISSING_SECRETS+=("SERVER_HOST")
          fi
          if [ -z "${{ secrets.SERVER_USER }}" ]; then
            MISSING_SECRETS+=("SERVER_USER")
          fi
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            MISSING_SECRETS+=("SSH_PRIVATE_KEY")
          fi
          if [ -z "${{ secrets.RCON_PASSWORD }}" ]; then
            MISSING_SECRETS+=("RCON_PASSWORD")
          fi

          if [ ${#MISSING_SECRETS[@]} -gt 0 ]; then
            echo "::error::Missing required secrets: ${MISSING_SECRETS[*]}"
            echo ""
            echo "Please add the following secrets to your repository:"
            echo "Settings > Secrets and variables > Actions > New repository secret"
            echo ""
            for secret in "${MISSING_SECRETS[@]}"; do
              echo "- $secret"
            done
            exit 1
          fi

          echo "âœ“ All required secrets are configured"

      - name: Deploy Minecraft server
        uses: appleboy/ssh-action@v1.0.3
        env:
          RCON_PASSWORD: ${{ secrets.RCON_PASSWORD }}
          ACTION: ${{ github.event.inputs.action || 'deploy' }}
          WORLD_SEED: ${{ secrets.WORLD_SEED }}
          OP_OWNER: ${{ secrets.OP_OWNER }}
          OP_ADDITIONAL: ${{ secrets.OP_ADDITIONAL }}
          MINECRAFT_VERSION: ${{ secrets.MINECRAFT_VERSION }}
          WHITELIST_ENABLED: ${{ secrets.WHITELIST_ENABLED }}
          WHITELIST_USERS: ${{ secrets.WHITELIST_USERS }}
          PLUGINS_URLS: ${{ secrets.PLUGINS_URLS }}
          SPIGET_RESOURCES: ${{ secrets.SPIGET_RESOURCES }}
          SERVER_ICON_URL: ${{ secrets.SERVER_ICON_URL }}
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: RCON_PASSWORD,ACTION,WORLD_SEED,OP_OWNER,OP_ADDITIONAL,MINECRAFT_VERSION,WHITELIST_ENABLED,WHITELIST_USERS,PLUGINS_URLS,SPIGET_RESOURCES,SERVER_ICON_URL
          script: |
            set -e

            DEPLOY_DIR="/home/deploy/minecraft-server"

            mkdir -p "$DEPLOY_DIR"
            cd "$DEPLOY_DIR"

            # Create .env file from secret
            cat > .env <<EOF
            RCON_PASSWORD="${RCON_PASSWORD}"
            EOF
            chmod 600 .env

            # Combine OP settings
            OPS=""
            if [ -n "$OP_OWNER" ] && [ -n "$OP_ADDITIONAL" ]; then
              OPS="$OP_OWNER,$OP_ADDITIONAL"
            elif [ -n "$OP_OWNER" ]; then
              OPS="$OP_OWNER"
            elif [ -n "$OP_ADDITIONAL" ]; then
              OPS="$OP_ADDITIONAL"
            fi

            # Create docker-compose.yml with base configuration
            cat > docker-compose.yml <<EOF
            services:
              minecraft-server:
                image: itzg/minecraft-server:java21
                container_name: minecraft-server
                restart: unless-stopped
                tty: true
                stdin_open: true
                # DNS servers to avoid 127.0.0.53 resolution issues in containers
                # Required for downloading Paper MC and plugins
                dns:
                  - 8.8.8.8
                  - 8.8.4.4
                  - 1.1.1.1
                environment:
                  EULA: "TRUE"
                  TYPE: "PAPER"
                  VERSION: "${MINECRAFT_VERSION:-1.20.4}"
                  MEMORY: "4G"
                  USE_AIKAR_FLAGS: "true"
                  ENABLE_RCON: "true"
                  RCON_PASSWORD: "${RCON_PASSWORD}"
                  RCON_PORT: 25575
                  MOTD: "Â§6Â§lâœ¦ Â§bÂ§lFestas Builds Â§6Â§lâœ¦ Â§rÂ§f - Community Server"
                  MAX_PLAYERS: 20
                  DIFFICULTY: "normal"
                  MODE: "survival"
                  PVP: "true"
                  ONLINE_MODE: "true"
                  VIEW_DISTANCE: 10
                  SPAWN_PROTECTION: 16
            EOF

            # Add optional SEED if provided (use single quotes to handle negative numbers)
            if [ -n "$WORLD_SEED" ]; then
              cat >> docker-compose.yml <<EOF
                  SEED: '${WORLD_SEED}'
            EOF
            fi

            # Add OPS if provided
            if [ -n "$OPS" ]; then
              cat >> docker-compose.yml <<EOF
                  OPS: "$OPS"
            EOF
            fi

            # Add whitelist settings if enabled
            if [ "$WHITELIST_ENABLED" = "true" ] && [ -n "$WHITELIST_USERS" ]; then
              cat >> docker-compose.yml <<EOF
                  WHITELIST: "$WHITELIST_USERS"
                  ENABLE_WHITELIST: "TRUE"
                  ENFORCE_WHITELIST: "TRUE"
            EOF
            fi

            # Add plugin URLs if provided
            if [ -n "$PLUGINS_URLS" ]; then
              # Convert comma-separated list to multi-line format
              PLUGINS_FORMATTED=$(echo "$PLUGINS_URLS" | tr ',' '\n' | sed 's/^/                    /')
              cat >> docker-compose.yml <<EOF
                  PLUGINS: |
            $PLUGINS_FORMATTED
            EOF
            fi

            # Add Spiget resources if provided
            if [ -n "$SPIGET_RESOURCES" ]; then
              cat >> docker-compose.yml <<EOF
                  SPIGET_RESOURCES: "$SPIGET_RESOURCES"
            EOF
            fi

            # Add server icon URL if provided
            if [ -n "$SERVER_ICON_URL" ]; then
              cat >> docker-compose.yml <<EOF
                  ICON: "$SERVER_ICON_URL"
            EOF
            fi

            # Complete the docker-compose.yml file
            cat >> docker-compose.yml <<'EOF'
                ports:
                  - "25565:25565"
                volumes:
                  - minecraft_data:/data
                networks:
                  - caddy-network
                healthcheck:
                  test: mc-health
                  interval: 30s
                  timeout: 10s
                  retries: 3
                  start_period: 120s

            volumes:
              minecraft_data:
                name: minecraft_data

            networks:
              caddy-network:
                external: true
            EOF

            # Create caddy-network if it doesn't exist
            docker network inspect caddy-network >/dev/null 2>&1 || docker network create caddy-network

            # Perform action based on input
            ACTION="${ACTION:-deploy}"

            case "${ACTION}" in
              deploy)
                echo "=== Deploying Minecraft Server ==="
                docker compose pull
                docker compose up -d
                ;;
              restart)
                echo "=== Restarting Minecraft Server ==="
                docker compose restart
                ;;
              stop)
                echo "=== Stopping Minecraft Server ==="
                docker compose stop
                echo "âœ“ Server stopped"
                ;;
              start)
                echo "=== Starting Minecraft Server ==="
                docker compose start
                ;;
              update)
                echo "=== Updating Minecraft Server ==="
                docker compose pull
                docker compose up -d --force-recreate
                ;;
              logs)
                echo "=== Recent Minecraft Server Logs ==="
                docker logs minecraft-server --tail=200
                exit 0
                ;;
              *)
                echo "::error::Invalid action: $ACTION"
                echo "Valid actions: deploy, restart, stop, start, update, logs"
                exit 1
                ;;
            esac

            # Only check health for actions that start the server
            case "$ACTION" in
              deploy|start|update)
                echo "Waiting for Minecraft server to become healthy (this may take up to 2 minutes)..."
                for i in $(seq 1 60); do
                  HEALTH=$(docker inspect --format='{{.State.Health.Status}}' minecraft-server 2>/dev/null \
                    || echo "starting")
                  if [ "$HEALTH" = "healthy" ]; then
                    echo "âœ“ Minecraft server is healthy"
                    break
                  fi
                  echo "Health status: $HEALTH (attempt $i/60)"
                  sleep 2
                done

                # Verify final health
                FINAL_HEALTH=$(docker inspect --format='{{.State.Health.Status}}' minecraft-server 2>/dev/null \
                  || echo "unknown")
                if [ "$FINAL_HEALTH" != "healthy" ]; then
                  echo "::error::Server did not become healthy. Status: $FINAL_HEALTH"
                  docker logs minecraft-server --tail=50
                  exit 1
                fi
                ;;
            esac

            # Show final status (except for logs action)
            if [ "$ACTION" != "logs" ]; then
              docker ps | grep minecraft-server || true
              echo "âœ“ Minecraft server operation completed successfully!"
            fi

      - name: Handle deployment failure
        if: failure()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "=== Deployment Failed - Diagnostics ==="
            echo ""
            echo "=== Container Status ==="
            docker ps -a | grep minecraft-server || echo "Container not found"
            echo ""
            echo "=== Container Logs ==="
            docker logs minecraft-server --tail=100 2>&1 || echo "No logs available"
            echo ""
            echo "=== Recent Docker Events ==="
            docker events --since 5m --until 1s 2>&1 | grep minecraft-server || echo "No recent events"

      - name: Deployment summary
        if: success()
        run: |
          ACTION="${{ github.event.inputs.action || 'deploy' }}"
          {
            case "$ACTION" in
              deploy|update)
                echo "## Minecraft Server Deployed! ðŸš€"
                echo ""
                echo "The Minecraft server has been deployed and is running."
                ;;
              restart)
                echo "## Minecraft Server Restarted! ðŸ”„"
                echo ""
                echo "The server has been restarted."
                ;;
              stop)
                echo "## Minecraft Server Stopped! â¹ï¸"
                echo ""
                echo "The server has been stopped. Use 'start' action to bring it back up."
                ;;
              start)
                echo "## Minecraft Server Started! â–¶ï¸"
                echo ""
                echo "The server has been started."
                ;;
              logs)
                echo "## Minecraft Server Logs Retrieved! ðŸ“‹"
                echo ""
                echo "Check the workflow output for recent logs."
                ;;
            esac
            echo ""
            echo "**Container:** minecraft-server"
            echo "**Network:** caddy-network"
          } >> "$GITHUB_STEP_SUMMARY"
