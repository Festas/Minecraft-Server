name: Deploy Website

on:
  push:
    branches:
      - main
    paths:
      - 'website/**'
      - '.github/workflows/deploy-website.yml'
  workflow_dispatch:  # Allow manual triggering

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      image_sha: ${{ steps.image_sha.outputs.sha }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get short SHA
        id: image_sha
        run: echo "sha=$(git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./website
          file: ./website/Dockerfile
          push: true
          tags: |
            ghcr.io/festas/minecraft-server-web:${{ steps.image_sha.outputs.sha }}
            ghcr.io/festas/minecraft-server-web:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        env:
          IMAGE_SHA: ${{ needs.build-and-push.outputs.image_sha }}
          REGISTRY: ghcr.io
          IMAGE_NAME: festas/minecraft-server-web
          DOMAIN: ${{ secrets.DOMAIN }}
          GHCR_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GHCR_ACTOR: ${{ github.actor }}
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: IMAGE_SHA,REGISTRY,IMAGE_NAME,DOMAIN,GHCR_TOKEN,GHCR_ACTOR
          script: |
            set -e
            
            DEPLOY_DIR="/home/deploy/minecraft-website"
            
            # Create deployment directory
            mkdir -p "$DEPLOY_DIR"
            cd "$DEPLOY_DIR"
            
            # Log in to GHCR
            echo "$GHCR_TOKEN" | docker login ghcr.io -u "$GHCR_ACTOR" --password-stdin
            
            # Pull the specific SHA-tagged image
            echo "Pulling image: ${REGISTRY}/${IMAGE_NAME}:${IMAGE_SHA}"
            docker pull "${REGISTRY}/${IMAGE_NAME}:${IMAGE_SHA}"
            
            # Generate docker-compose.yml
            cat > docker-compose.yml <<EOF_COMPOSE
            services:
              minecraft-web:
                image: ${REGISTRY}/${IMAGE_NAME}:${IMAGE_SHA}
                container_name: minecraft-web
                restart: unless-stopped
                expose:
                  - "80"
                healthcheck:
                  test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
                  interval: 30s
                  timeout: 10s
                  retries: 3
                  start_period: 10s
                networks:
                  - caddy-network

            networks:
              caddy-network:
                external: true
            EOF_COMPOSE
            
            # Create external network if it doesn't exist
            if ! docker network inspect caddy-network >/dev/null 2>&1; then
              echo "Creating caddy-network..."
              docker network create caddy-network
            fi
            
            # Deploy with docker compose
            docker compose up -d
            
            # Wait for health check
            echo "Waiting for container to be healthy..."
            for i in {1..30}; do
              HEALTH=$(docker inspect --format='{{.State.Health.Status}}' minecraft-web 2>/dev/null || echo "starting")
              echo "Health status: $HEALTH (attempt $i/30)"
              if [ "$HEALTH" = "healthy" ]; then
                echo "âœ“ Container is healthy"
                break
              fi
              if [ $i -eq 30 ]; then
                echo "âœ— Container did not become healthy in time"
                docker logs minecraft-web --tail=50
                exit 1
              fi
              sleep 2
            done
            
            # Clean up old images
            echo "Cleaning up old images..."
            docker image prune -f --filter "label=org.opencontainers.image.source=https://github.com/festas/minecraft-server"
            
            # Success message
            echo "âœ“ Deployment successful!"
            echo "Website URL: https://mc.festas-builds.com"

      - name: Handle deployment failure
        if: failure()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "=== Deployment Failed - Diagnostics ==="
            echo ""
            echo "=== Container Status ==="
            docker ps -a | grep minecraft-web || echo "Container not found"
            echo ""
            echo "=== Container Logs ==="
            docker logs minecraft-web --tail=100 2>&1 || echo "No logs available"
            echo ""
            echo "=== Recent Docker Events ==="
            docker events --since 5m --until 1s 2>&1 | grep minecraft-web || echo "No recent events"

      - name: Deployment summary
        if: success()
        run: |
          {
            echo "## Deployment Successful! ðŸš€"
            echo ""
            echo "The website has been deployed and is now live!"
            echo ""
            echo "**Docker Image:** ghcr.io/festas/minecraft-server-web:${{ needs.build-and-push.outputs.image_sha }}"
            echo "**Website URL:** https://mc.festas-builds.com"
          } >> "$GITHUB_STEP_SUMMARY"
