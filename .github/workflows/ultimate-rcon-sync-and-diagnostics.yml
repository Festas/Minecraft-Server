name: Ultimate RCON Sync & Diagnostics

'on':
  workflow_dispatch:
    inputs:
      RCON_PASSWORD:
        description: 'RCON Password (optional - uses secret if not provided)'
        required: false
        type: string
      action:
        description: 'Action to perform'
        required: true
        default: 'diagnose'
        type: choice
        options:
          - diagnose
          - fix

jobs:
  rcon-diagnostics:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate required secrets
        run: |
          MISSING_SECRETS=()

          if [ -z "${{ secrets.SERVER_HOST }}" ]; then
            MISSING_SECRETS+=("SERVER_HOST")
          fi
          if [ -z "${{ secrets.SERVER_USER }}" ]; then
            MISSING_SECRETS+=("SERVER_USER")
          fi
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            MISSING_SECRETS+=("SSH_PRIVATE_KEY")
          fi
          if [ -z "${{ secrets.RCON_PASSWORD }}" ] && [ -z "${{ github.event.inputs.RCON_PASSWORD }}" ]; then
            MISSING_SECRETS+=("RCON_PASSWORD (secret or input)")
          fi

          if [ ${#MISSING_SECRETS[@]} -gt 0 ]; then
            echo "::error::Missing required secrets/inputs: ${MISSING_SECRETS[*]}"
            echo ""
            echo "Please add the following secrets to your repository:"
            echo "Settings > Secrets and variables > Actions > New repository secret"
            echo ""
            for secret in "${MISSING_SECRETS[@]}"; do
              echo "- $secret"
            done
            exit 1
          fi

          echo "âœ“ All required secrets/inputs are configured"

      - name: Run RCON diagnostics and fixes
        id: diagnostics
        uses: appleboy/ssh-action@v1.2.4
        env:
          ACTION: ${{ github.event.inputs.action }}
          RCON_PASSWORD: ${{ github.event.inputs.RCON_PASSWORD || secrets.RCON_PASSWORD }}
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: ACTION,RCON_PASSWORD
          command_timeout: 15m
          script: |
            set -e

            # Navigate to the repository directory
            cd /home/deploy/minecraft-server

            # Pull latest changes to get the diagnose.sh script
            git pull origin main || true

            # Run the external diagnostics script
            export RCON_PASSWORD="${RCON_PASSWORD}"
            bash scripts/diagnostics/diagnose.sh "${ACTION}"

            # Output the diagnostics directory path for artifact upload
            DIAG_DIR=$(ls -td /tmp/rcon-diagnostics-* 2>/dev/null | head -1)
            echo "DIAGNOSTICS_DIR=${DIAG_DIR}"

      - name: Download diagnostics logs
        if: always()
        run: |
          # Get the latest diagnostics directory from the server
          DIAG_DIR=$(ssh -o StrictHostKeyChecking=no -i <(echo "${{ secrets.SSH_PRIVATE_KEY }}") \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
            "ls -td /tmp/rcon-diagnostics-* 2>/dev/null | head -1")

          if [ -n "$DIAG_DIR" ]; then
            echo "Downloading diagnostics from: $DIAG_DIR"
            mkdir -p rcon-diagnostics-logs
            scp -o StrictHostKeyChecking=no -i <(echo "${{ secrets.SSH_PRIVATE_KEY }}") \
              -r ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:"${DIAG_DIR}/*" \
              rcon-diagnostics-logs/ || echo "Warning: Failed to download some files"
          else
            echo "No diagnostics directory found"
          fi

      - name: Upload diagnostics logs artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rcon-diagnostics-logs
          path: rcon-diagnostics-logs/
          retention-days: 30
          if-no-files-found: warn

      - name: Create diagnostics summary
        if: always()
        run: |
          ACTION="${{ github.event.inputs.action }}"
          {
            echo "## Ultimate RCON Sync & Diagnostics ðŸ”§"
            echo ""
            echo "**Action performed:** \`${ACTION}\`"
            echo "**Timestamp:** $(date)"
            echo ""

            if [ "$ACTION" = "diagnose" ]; then
              echo "### Diagnostics Mode"
              echo ""
              echo "A comprehensive diagnostic report has been generated covering:"
              echo "- âœ… Docker Compose configurations"
              echo "- âœ… Container environment variables"
              echo "- âœ… .env and server.properties files"
              echo "- âœ… Docker volume mounts"
              echo "- âœ… Container logs (100 lines each)"
              echo "- âœ… Network TCP connectivity tests"
              echo "- âœ… RCON command tests (rcon-cli and Node)"
              echo "- âœ… RCON-related log entries"
              echo "- âœ… Password hash analysis (SHA256, MD5, length)"
              echo "- âœ… Container status summary"
              echo ""
              echo "### Next Steps"
              echo ""
              echo "1. **Review the workflow logs** for any âœ— or âš  indicators"
              echo "2. **Check Section 9 (Password Analysis)** for hash mismatches"
              echo "3. **If passwords don't match:** Run this workflow again with action='fix'"
              echo "4. **Download diagnostics** for offline review or to attach to support requests"
              echo ""
              echo "### Downloading Diagnostics"
              echo ""
              echo "**Option 1: Download from GitHub Artifacts (Recommended)**"
              echo ""
              echo "- Click on the 'Summary' tab at the top of this workflow run"
              echo "- Scroll down to the 'Artifacts' section"
              echo "- Download the \`rcon-diagnostics-logs\` artifact (available for 30 days)"
              echo ""
              echo "**Option 2: Download directly from server via SCP**"
              echo ""
              echo "\`\`\`bash"
              echo "# Check the workflow logs for the diagnostics directory path, then:"
              echo "scp -r ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/tmp/rcon-diagnostics-* ."
              echo "\`\`\`"
              echo ""

            elif [ "$ACTION" = "fix" ]; then
              echo "### Fix Mode - Password Synchronization"
              echo ""
              echo "The following actions were performed:"
              echo "1. âœ… **Pre-fix diagnostics** captured"
              echo "2. âœ… **Server .env** updated with RCON_PASSWORD"
              echo "3. âœ… **Console .env** updated with RCON_PASSWORD"
              echo "4. âœ… **docker-compose.yml** updated (password escaped for Docker Compose)"
              echo "5. âœ… **Minecraft server container** recreated (--force-recreate)"
              echo "6. âœ… **Console container** recreated (--force-recreate)"
              echo "7. âœ… **Post-fix diagnostics** captured"
              echo "8. âœ… **RCON command test** executed"
              echo ""
              echo "### Verification"
              echo ""
              echo "Check the workflow logs above for the final RCON test result."
              echo ""
              echo "- **If test passed:** ðŸŽ‰ RCON is now working correctly!"
              echo "- **If test failed:** Review the post-fix diagnostics in the logs"
              echo ""
              echo "### What Changed"
              echo ""
              echo "The RCON_PASSWORD has been synchronized across:"
              echo "- GitHub secret/input â†’ Server .env"
              echo "- GitHub secret/input â†’ Console .env"
              echo "- GitHub secret/input â†’ docker-compose.yml (escaped)"
              echo "- Containers recreated to apply environment variables"
              echo "- Server.properties will be updated by itzg/minecraft-server"
              echo "  on container start (via OVERRIDE_SERVER_PROPERTIES)"
              echo ""
              echo "### Next Steps"
              echo ""
              echo "1. **Test console UI** - Verify RCON commands work from the web console"
              echo "2. **Monitor logs** - Check for any authentication errors"
              echo "3. **Download diagnostics** for your records"
              echo ""
              echo "**Option 1: Download from GitHub Artifacts (Recommended)**"
              echo ""
              echo "- Click on the 'Summary' tab at the top of this workflow run"
              echo "- Scroll down to the 'Artifacts' section"
              echo "- Download the \`rcon-diagnostics-logs\` artifact (available for 30 days)"
              echo ""
              echo "**Option 2: Download directly from server via SCP**"
              echo ""
              echo "\`\`\`bash"
              echo "# Check the workflow logs for the diagnostics directory path, then:"
              echo "scp -r ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/tmp/rcon-diagnostics-* ."
              echo "\`\`\`"
              echo ""
            fi

            echo "### Security Note"
            echo ""
            echo "All password values are redacted in diagnostics output."
            echo "Only hashes (SHA256, MD5) and lengths are shown for comparison."
            echo ""
            echo "---"
            echo ""
            echo "**Need help?** Review the diagnostics output above or download"
            echo "the complete diagnostics package for detailed analysis."
          } >> "$GITHUB_STEP_SUMMARY"
