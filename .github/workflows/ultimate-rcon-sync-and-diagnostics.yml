name: Ultimate RCON Sync & Diagnostics

'on':
  workflow_dispatch:
    inputs:
      RCON_PASSWORD:
        description: 'RCON Password (optional - uses secret if not provided)'
        required: false
        type: string
      action:
        description: 'Action to perform'
        required: true
        default: 'diagnose'
        type: choice
        options:
          - diagnose
          - fix

jobs:
  rcon-diagnostics:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate required secrets
        run: |
          MISSING_SECRETS=()

          if [ -z "${{ secrets.SERVER_HOST }}" ]; then
            MISSING_SECRETS+=("SERVER_HOST")
          fi
          if [ -z "${{ secrets.SERVER_USER }}" ]; then
            MISSING_SECRETS+=("SERVER_USER")
          fi
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            MISSING_SECRETS+=("SSH_PRIVATE_KEY")
          fi
          if [ -z "${{ secrets.RCON_PASSWORD }}" ] && [ -z "${{ github.event.inputs.RCON_PASSWORD }}" ]; then
            MISSING_SECRETS+=("RCON_PASSWORD (secret or input)")
          fi

          if [ ${#MISSING_SECRETS[@]} -gt 0 ]; then
            echo "::error::Missing required secrets/inputs: ${MISSING_SECRETS[*]}"
            echo ""
            echo "Please add the following secrets to your repository:"
            echo "Settings > Secrets and variables > Actions > New repository secret"
            echo ""
            for secret in "${MISSING_SECRETS[@]}"; do
              echo "- $secret"
            done
            exit 1
          fi

          echo "âœ“ All required secrets/inputs are configured"

      - name: Run RCON diagnostics and fixes
        uses: appleboy/ssh-action@v1.0.3
        env:
          ACTION: ${{ github.event.inputs.action }}
          RCON_PASSWORD: ${{ github.event.inputs.RCON_PASSWORD || secrets.RCON_PASSWORD }}
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: ACTION,RCON_PASSWORD
          command_timeout: 15m
          script: |
            set -e

            # Define deployment directories
            DEPLOY_DIR="/home/deploy/minecraft-server"
            CONSOLE_DIR="/home/deploy/minecraft-console"
            DIAGNOSTICS_DIR="/tmp/rcon-diagnostics-$(date +%Y%m%d-%H%M%S)"

            mkdir -p "$DIAGNOSTICS_DIR"

            echo "============================================================"
            echo "ULTIMATE RCON SYNC & DIAGNOSTICS"
            echo "============================================================"
            echo "Timestamp: $(date)"
            echo "Action: ${ACTION}"
            echo "Diagnostics directory: $DIAGNOSTICS_DIR"
            echo "============================================================"
            echo ""

            # Function to safely hash passwords (no newlines, consistent)
            hash_password() {
              echo -n "$1" | sha256sum | cut -d' ' -f1
            }

            # Function to get password length safely
            get_password_length() {
              echo -n "$1" | wc -c
            }

            # Function to run comprehensive diagnostics
            run_diagnostics() {
              local STAGE="$1"
              local OUTPUT_PREFIX="${DIAGNOSTICS_DIR}/${STAGE}"

              echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
              echo "â•‘  STAGE: ${STAGE} - COMPREHENSIVE DIAGNOSTICS          â•‘"
              echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
              echo ""

              # ========== SECTION 1: DOCKER COMPOSE CONFIGURATION ==========
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "SECTION 1: Docker Compose Configuration"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo ""

              echo "[Minecraft Server docker-compose.yml]"
              if [ -f "$DEPLOY_DIR/docker-compose.yml" ]; then
                cat "$DEPLOY_DIR/docker-compose.yml" | tee "${OUTPUT_PREFIX}-server-docker-compose.yml"
                echo ""
              else
                echo "âš  docker-compose.yml not found at $DEPLOY_DIR" | tee "${OUTPUT_PREFIX}-server-docker-compose.yml"
                echo ""
              fi

              echo "[Console docker-compose.yml]"
              if [ -f "$CONSOLE_DIR/docker-compose.yml" ]; then
                cat "$CONSOLE_DIR/docker-compose.yml" | tee "${OUTPUT_PREFIX}-console-docker-compose.yml"
                echo ""
              else
                echo "âš  docker-compose.yml not found at $CONSOLE_DIR" | tee "${OUTPUT_PREFIX}-console-docker-compose.yml"
                echo ""
              fi

              # ========== SECTION 2: CONTAINER ENVIRONMENT VARIABLES ==========
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "SECTION 2: Container Environment Variables (RCON-related)"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo ""

              echo "[Minecraft Server Container Environment]"
              if docker ps --format '{{.Names}}' | grep -q '^minecraft-server$'; then
                docker exec minecraft-server env | grep -E "RCON|ENABLE" | sort | tee "${OUTPUT_PREFIX}-server-env.txt"
                echo ""
                echo "Full environment (redacted):"
                docker exec minecraft-server env | grep -v PASSWORD | grep -v SECRET | sort | tee "${OUTPUT_PREFIX}-server-env-full.txt"
                echo ""
              else
                echo "âœ— minecraft-server container not running" | tee "${OUTPUT_PREFIX}-server-env.txt"
                echo ""
              fi

              echo "[Console Container Environment]"
              if docker ps --format '{{.Names}}' | grep -q '^minecraft-console$'; then
                docker exec minecraft-console env | grep -E "RCON|ADMIN|SESSION" | grep -v PASSWORD | grep -v SECRET | sort | tee "${OUTPUT_PREFIX}-console-env.txt"
                echo ""
                echo "Full environment (redacted):"
                docker exec minecraft-console env | grep -v PASSWORD | grep -v SECRET | sort | tee "${OUTPUT_PREFIX}-console-env-full.txt"
                echo ""
              else
                echo "âœ— minecraft-console container not running" | tee "${OUTPUT_PREFIX}-console-env.txt"
                echo ""
              fi

              # ========== SECTION 3: .ENV AND SERVER.PROPERTIES FILES ==========
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "SECTION 3: Configuration Files (.env and server.properties)"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo ""

              echo "[Minecraft Server .env file]"
              if [ -f "$DEPLOY_DIR/.env" ]; then
                # Redact password value, show structure
                sed 's/\(RCON_PASSWORD=\).*/\1[REDACTED]/' "$DEPLOY_DIR/.env" | tee "${OUTPUT_PREFIX}-server-env-file.txt"
                echo ""
              else
                echo "âœ— .env file not found at $DEPLOY_DIR" | tee "${OUTPUT_PREFIX}-server-env-file.txt"
                echo ""
              fi

              echo "[Console .env file]"
              if [ -f "$CONSOLE_DIR/.env" ]; then
                # Redact passwords and secrets
                sed -E 's/(PASSWORD|SECRET)=.*/\1=[REDACTED]/' "$CONSOLE_DIR/.env" | tee "${OUTPUT_PREFIX}-console-env-file.txt"
                echo ""
              else
                echo "âœ— .env file not found at $CONSOLE_DIR" | tee "${OUTPUT_PREFIX}-console-env-file.txt"
                echo ""
              fi

              echo "[Minecraft server.properties]"
              if docker ps --format '{{.Names}}' | grep -q '^minecraft-server$'; then
                if docker exec minecraft-server test -f /data/server.properties; then
                  docker exec minecraft-server cat /data/server.properties | grep -E "rcon\.|enable-rcon" | sed 's/\(rcon.password=\).*/\1[REDACTED]/' | tee "${OUTPUT_PREFIX}-server-properties.txt"
                  echo ""
                else
                  echo "âœ— server.properties not found in container" | tee "${OUTPUT_PREFIX}-server-properties.txt"
                  echo ""
                fi
              else
                echo "âœ— Cannot access server.properties (container not running)" | tee "${OUTPUT_PREFIX}-server-properties.txt"
                echo ""
              fi

              # ========== SECTION 4: DOCKER VOLUME MOUNTS ==========
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "SECTION 4: Docker Volume Mounts"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo ""

              echo "[Minecraft Server Volumes]"
              if docker ps -a --format '{{.Names}}' | grep -q '^minecraft-server$'; then
                docker inspect minecraft-server --format '{{range .Mounts}}Type: {{.Type}}, Source: {{.Source}}, Destination: {{.Destination}}, Mode: {{.Mode}}, RW: {{.RW}}{{"\n"}}{{end}}' | tee "${OUTPUT_PREFIX}-server-volumes.txt"
                echo ""
              else
                echo "âœ— minecraft-server container not found" | tee "${OUTPUT_PREFIX}-server-volumes.txt"
                echo ""
              fi

              echo "[Console Volumes]"
              if docker ps -a --format '{{.Names}}' | grep -q '^minecraft-console$'; then
                docker inspect minecraft-console --format '{{range .Mounts}}Type: {{.Type}}, Source: {{.Source}}, Destination: {{.Destination}}, Mode: {{.Mode}}, RW: {{.RW}}{{"\n"}}{{end}}' | tee "${OUTPUT_PREFIX}-console-volumes.txt"
                echo ""
              else
                echo "âœ— minecraft-console container not found" | tee "${OUTPUT_PREFIX}-console-volumes.txt"
                echo ""
              fi

              # ========== SECTION 5: CONTAINER LOGS ==========
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "SECTION 5: Recent Container Logs (last 100 lines)"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo ""

              echo "[Minecraft Server Logs]"
              if docker ps --format '{{.Names}}' | grep -q '^minecraft-server$'; then
                docker logs minecraft-server --tail=100 2>&1 | tee "${OUTPUT_PREFIX}-server-logs.txt"
                echo ""
              else
                echo "âœ— minecraft-server container not running" | tee "${OUTPUT_PREFIX}-server-logs.txt"
                echo ""
              fi

              echo "[Console Logs]"
              if docker ps --format '{{.Names}}' | grep -q '^minecraft-console$'; then
                docker logs minecraft-console --tail=100 2>&1 | tee "${OUTPUT_PREFIX}-console-logs.txt"
                echo ""
              else
                echo "âœ— minecraft-console container not running" | tee "${OUTPUT_PREFIX}-console-logs.txt"
                echo ""
              fi

              # ========== SECTION 6: NETWORK CONNECTIVITY ==========
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "SECTION 6: Network TCP Check (Console â†’ Server:25575)"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo ""

              if docker ps --format '{{.Names}}' | grep -q '^minecraft-server$' && docker ps --format '{{.Names}}' | grep -q '^minecraft-console$'; then
                echo "Testing TCP connectivity from console to minecraft-server:25575..."
                if docker exec minecraft-console nc -zv minecraft-server 25575 2>&1 | tee "${OUTPUT_PREFIX}-network-tcp-check.txt"; then
                  echo "âœ“ TCP connection successful"
                else
                  echo "âœ— TCP connection failed"
                fi
                echo ""

                echo "Testing port listening inside server container..."
                if docker exec minecraft-server netstat -tlnp 2>/dev/null | grep 25575 | tee -a "${OUTPUT_PREFIX}-network-tcp-check.txt"; then
                  echo "âœ“ Port 25575 is listening"
                else
                  echo "âš  Port 25575 may not be listening"
                fi
                echo ""
              else
                echo "âŠ˜ Skipped (one or both containers not running)" | tee "${OUTPUT_PREFIX}-network-tcp-check.txt"
                echo ""
              fi

              # ========== SECTION 7: RCON COMMAND TESTS ==========
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "SECTION 7: RCON Command Tests"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo ""

              echo "[rcon-cli test from minecraft-server container]"
              if docker ps --format '{{.Names}}' | grep -q '^minecraft-server$'; then
                if docker exec minecraft-server rcon-cli list 2>&1 | tee "${OUTPUT_PREFIX}-rcon-cli-test.txt"; then
                  echo "âœ“ rcon-cli command successful"
                else
                  echo "âœ— rcon-cli command failed (authentication or connectivity issue)"
                fi
                echo ""
              else
                echo "âŠ˜ Skipped (minecraft-server not running)" | tee "${OUTPUT_PREFIX}-rcon-cli-test.txt"
                echo ""
              fi

              echo "[rcon-client Node test from console container]"
              if docker ps --format '{{.Names}}' | grep -q '^minecraft-console$'; then
                # Try to execute a simple rcon test via console's Node.js environment
                echo "Attempting Node.js RCON client test..."
                if docker exec minecraft-console sh -c "command -v node >/dev/null 2>&1" 2>&1; then
                  echo "Node.js is available in console container"
                  # Check if console has rcon functionality
                  docker exec minecraft-console sh -c "ls -la /app/services/rcon.js 2>/dev/null || echo 'RCON service file not found'" | tee "${OUTPUT_PREFIX}-rcon-node-test.txt"
                else
                  echo "Node.js not found in console container" | tee "${OUTPUT_PREFIX}-rcon-node-test.txt"
                fi
                echo ""
              else
                echo "âŠ˜ Skipped (minecraft-console not running)" | tee "${OUTPUT_PREFIX}-rcon-node-test.txt"
                echo ""
              fi

              # ========== SECTION 8: RCON-RELATED LOG LINES ==========
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "SECTION 8: RCON-Related Log Entries"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo ""

              echo "[Minecraft Server RCON log entries]"
              if docker ps --format '{{.Names}}' | grep -q '^minecraft-server$'; then
                docker logs minecraft-server 2>&1 | grep -i rcon | tail -50 | tee "${OUTPUT_PREFIX}-server-rcon-logs.txt" || echo "No RCON entries found"
                echo ""
              else
                echo "âŠ˜ Skipped (container not running)" | tee "${OUTPUT_PREFIX}-server-rcon-logs.txt"
                echo ""
              fi

              echo "[Console RCON/connection log entries]"
              if docker ps --format '{{.Names}}' | grep -q '^minecraft-console$'; then
                docker logs minecraft-console 2>&1 | grep -iE "rcon|connection|auth" | tail -50 | tee "${OUTPUT_PREFIX}-console-rcon-logs.txt" || echo "No RCON entries found"
                echo ""
              else
                echo "âŠ˜ Skipped (container not running)" | tee "${OUTPUT_PREFIX}-console-rcon-logs.txt"
                echo ""
              fi

              # ========== SECTION 9: PASSWORD ANALYSIS ==========
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "SECTION 9: Password Hash & Length Analysis (No Secrets Exposed)"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo ""

              {
                echo "Password Source Analysis:"
                echo "========================="
                echo ""

                # GitHub/Input Secret
                SECRET_HASH=$(hash_password "${RCON_PASSWORD}")
                SECRET_LENGTH=$(get_password_length "${RCON_PASSWORD}")
                SECRET_MD5=$(echo -n "${RCON_PASSWORD}" | md5sum | cut -d' ' -f1)
                echo "1. GitHub Secret / Input Password:"
                echo "   SHA256: $SECRET_HASH"
                echo "   MD5:    $SECRET_MD5"
                echo "   Length: $SECRET_LENGTH characters"
                echo ""

                # Server .env file
                if [ -f "$DEPLOY_DIR/.env" ]; then
                  SERVER_ENV_VALUE=$(grep "^RCON_PASSWORD=" "$DEPLOY_DIR/.env" 2>/dev/null | cut -d'=' -f2- | sed 's/^"\(.*\)"$/\1/' | tr -d '\r\n')
                  if [ -n "$SERVER_ENV_VALUE" ]; then
                    SERVER_ENV_HASH=$(hash_password "$SERVER_ENV_VALUE")
                    SERVER_ENV_LENGTH=$(get_password_length "$SERVER_ENV_VALUE")
                    SERVER_ENV_MD5=$(echo -n "$SERVER_ENV_VALUE" | md5sum | cut -d' ' -f1)
                    echo "2. Server .env File:"
                    echo "   SHA256: $SERVER_ENV_HASH"
                    echo "   MD5:    $SERVER_ENV_MD5"
                    echo "   Length: $SERVER_ENV_LENGTH characters"
                    echo "   Match with secret: $([ "$SERVER_ENV_HASH" = "$SECRET_HASH" ] && echo "âœ“ YES" || echo "âœ— NO")"
                  else
                    echo "2. Server .env File: âœ— RCON_PASSWORD not found or empty"
                  fi
                else
                  echo "2. Server .env File: âœ— File not found"
                fi
                echo ""

                # Console .env file
                if [ -f "$CONSOLE_DIR/.env" ]; then
                  CONSOLE_ENV_VALUE=$(grep "^RCON_PASSWORD=" "$CONSOLE_DIR/.env" 2>/dev/null | cut -d'=' -f2- | sed 's/^"\(.*\)"$/\1/' | tr -d '\r\n')
                  if [ -n "$CONSOLE_ENV_VALUE" ]; then
                    CONSOLE_ENV_HASH=$(hash_password "$CONSOLE_ENV_VALUE")
                    CONSOLE_ENV_LENGTH=$(get_password_length "$CONSOLE_ENV_VALUE")
                    CONSOLE_ENV_MD5=$(echo -n "$CONSOLE_ENV_VALUE" | md5sum | cut -d' ' -f1)
                    echo "3. Console .env File:"
                    echo "   SHA256: $CONSOLE_ENV_HASH"
                    echo "   MD5:    $CONSOLE_ENV_MD5"
                    echo "   Length: $CONSOLE_ENV_LENGTH characters"
                    echo "   Match with secret: $([ "$CONSOLE_ENV_HASH" = "$SECRET_HASH" ] && echo "âœ“ YES" || echo "âœ— NO")"
                  else
                    echo "3. Console .env File: âœ— RCON_PASSWORD not found or empty"
                  fi
                else
                  echo "3. Console .env File: âœ— File not found"
                fi
                echo ""

                # Server container environment
                if docker ps --format '{{.Names}}' | grep -q '^minecraft-server$'; then
                  SERVER_CONTAINER_VALUE=$(docker exec minecraft-server printenv RCON_PASSWORD 2>/dev/null || echo "")
                  if [ -n "$SERVER_CONTAINER_VALUE" ]; then
                    SERVER_CONTAINER_HASH=$(hash_password "$SERVER_CONTAINER_VALUE")
                    SERVER_CONTAINER_LENGTH=$(get_password_length "$SERVER_CONTAINER_VALUE")
                    SERVER_CONTAINER_MD5=$(echo -n "$SERVER_CONTAINER_VALUE" | md5sum | cut -d' ' -f1)
                    echo "4. Server Container Environment:"
                    echo "   SHA256: $SERVER_CONTAINER_HASH"
                    echo "   MD5:    $SERVER_CONTAINER_MD5"
                    echo "   Length: $SERVER_CONTAINER_LENGTH characters"
                    echo "   Match with secret: $([ "$SERVER_CONTAINER_HASH" = "$SECRET_HASH" ] && echo "âœ“ YES" || echo "âœ— NO")"
                  else
                    echo "4. Server Container Environment: âœ— RCON_PASSWORD not found"
                  fi
                else
                  echo "4. Server Container Environment: âŠ˜ Container not running"
                fi
                echo ""

                # Console container environment
                if docker ps --format '{{.Names}}' | grep -q '^minecraft-console$'; then
                  CONSOLE_CONTAINER_VALUE=$(docker exec minecraft-console printenv RCON_PASSWORD 2>/dev/null || echo "")
                  if [ -n "$CONSOLE_CONTAINER_VALUE" ]; then
                    CONSOLE_CONTAINER_HASH=$(hash_password "$CONSOLE_CONTAINER_VALUE")
                    CONSOLE_CONTAINER_LENGTH=$(get_password_length "$CONSOLE_CONTAINER_VALUE")
                    CONSOLE_CONTAINER_MD5=$(echo -n "$CONSOLE_CONTAINER_VALUE" | md5sum | cut -d' ' -f1)
                    echo "5. Console Container Environment:"
                    echo "   SHA256: $CONSOLE_CONTAINER_HASH"
                    echo "   MD5:    $CONSOLE_CONTAINER_MD5"
                    echo "   Length: $CONSOLE_CONTAINER_LENGTH characters"
                    echo "   Match with secret: $([ "$CONSOLE_CONTAINER_HASH" = "$SECRET_HASH" ] && echo "âœ“ YES" || echo "âœ— NO")"
                  else
                    echo "5. Console Container Environment: âœ— RCON_PASSWORD not found"
                  fi
                else
                  echo "5. Console Container Environment: âŠ˜ Container not running"
                fi
                echo ""

                # Server.properties file
                if docker ps --format '{{.Names}}' | grep -q '^minecraft-server$'; then
                  if docker exec minecraft-server test -f /data/server.properties; then
                    SERVER_PROPS_VALUE=$(docker exec minecraft-server grep "^rcon.password=" /data/server.properties 2>/dev/null | cut -d'=' -f2- | tr -d '\r\n' || echo "")
                    if [ -n "$SERVER_PROPS_VALUE" ]; then
                      SERVER_PROPS_HASH=$(hash_password "$SERVER_PROPS_VALUE")
                      SERVER_PROPS_LENGTH=$(get_password_length "$SERVER_PROPS_VALUE")
                      SERVER_PROPS_MD5=$(echo -n "$SERVER_PROPS_VALUE" | md5sum | cut -d' ' -f1)
                      echo "6. server.properties File:"
                      echo "   SHA256: $SERVER_PROPS_HASH"
                      echo "   MD5:    $SERVER_PROPS_MD5"
                      echo "   Length: $SERVER_PROPS_LENGTH characters"
                      echo "   Match with secret: $([ "$SERVER_PROPS_HASH" = "$SECRET_HASH" ] && echo "âœ“ YES" || echo "âœ— NO")"
                    else
                      echo "6. server.properties File: âœ— rcon.password not found or empty"
                    fi
                  else
                    echo "6. server.properties File: âœ— File not found"
                  fi
                else
                  echo "6. server.properties File: âŠ˜ Container not running"
                fi
                echo ""

                echo "================================================"
                echo "CONSISTENCY CHECK"
                echo "================================================"
                # Check if all non-empty hashes match
                ALL_MATCH=true
                if [ -n "$SERVER_ENV_VALUE" ] && [ "$SERVER_ENV_HASH" != "$SECRET_HASH" ]; then
                  ALL_MATCH=false
                  echo "âœ— Server .env does NOT match secret"
                fi
                if [ -n "$CONSOLE_ENV_VALUE" ] && [ "$CONSOLE_ENV_HASH" != "$SECRET_HASH" ]; then
                  ALL_MATCH=false
                  echo "âœ— Console .env does NOT match secret"
                fi
                if [ -n "$SERVER_CONTAINER_VALUE" ] && [ "$SERVER_CONTAINER_HASH" != "$SECRET_HASH" ]; then
                  ALL_MATCH=false
                  echo "âœ— Server container env does NOT match secret"
                fi
                if [ -n "$CONSOLE_CONTAINER_VALUE" ] && [ "$CONSOLE_CONTAINER_HASH" != "$SECRET_HASH" ]; then
                  ALL_MATCH=false
                  echo "âœ— Console container env does NOT match secret"
                fi
                if [ -n "$SERVER_PROPS_VALUE" ] && [ "$SERVER_PROPS_HASH" != "$SECRET_HASH" ]; then
                  ALL_MATCH=false
                  echo "âœ— server.properties does NOT match secret"
                fi

                if [ "$ALL_MATCH" = true ]; then
                  echo "âœ“ ALL PASSWORDS MATCH!"
                else
                  echo ""
                  echo "âš  PASSWORD MISMATCH DETECTED - Run 'fix' mode to synchronize"
                fi
              } | tee "${OUTPUT_PREFIX}-password-analysis.txt"
              echo ""

              # ========== SECTION 10: CONTAINER STATUS SUMMARY ==========
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "SECTION 10: Container Status Summary"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo ""

              {
                echo "Docker Containers:"
                docker ps -a --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" --filter "name=minecraft"
                echo ""
                echo "Docker Networks:"
                docker network ls | grep -E "NETWORK|caddy"
                echo ""
                echo "Caddy Network Details:"
                if docker network inspect caddy-network >/dev/null 2>&1; then
                  docker network inspect caddy-network --format '{{range .Containers}}{{.Name}}: {{.IPv4Address}}{{"\n"}}{{end}}'
                else
                  echo "âœ— caddy-network not found"
                fi
              } | tee "${OUTPUT_PREFIX}-container-status.txt"
              echo ""

              echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
              echo "â•‘  DIAGNOSTICS COMPLETE - Stage: ${STAGE}               â•‘"
              echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
              echo ""
            }

            # Function to synchronize passwords
            sync_passwords() {
              echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
              echo "â•‘  SYNCHRONIZING RCON PASSWORDS                          â•‘"
              echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
              echo ""

              echo "This will update RCON_PASSWORD in all locations to match the provided secret/input."
              echo ""

              # Step 1: Update Minecraft server .env
              echo "Step 1: Updating Minecraft server .env..."
              cd "$DEPLOY_DIR"
              printf 'RCON_PASSWORD=%s\n' "${RCON_PASSWORD}" > .env
              chmod 600 .env
              echo "âœ“ Minecraft server .env updated"
              echo ""

              # Step 2: Update Console .env
              echo "Step 2: Updating Console .env..."
              cd "$CONSOLE_DIR"
              if [ -f .env ]; then
                # Preserve other variables, update only RCON_PASSWORD
                grep -v "^RCON_PASSWORD=" .env > .env.tmp || true
                printf 'RCON_PASSWORD=%s\n' "${RCON_PASSWORD}" >> .env.tmp
                mv .env.tmp .env
                chmod 600 .env
                echo "âœ“ Console .env updated"
              else
                echo "âœ— Console .env not found - creating with RCON_PASSWORD only"
                printf 'RCON_PASSWORD=%s\n' "${RCON_PASSWORD}" > .env
                chmod 600 .env
              fi
              echo ""

              # Step 3: Update docker-compose.yml with escaped password
              echo "Step 3: Updating docker-compose.yml with escaped password..."
              cd "$DEPLOY_DIR"
              if [ -f docker-compose.yml ]; then
                # Escape $ as $$ for Docker Compose
                ESCAPED_RCON_PASSWORD=$(printf '%s' "${RCON_PASSWORD}" | sed 's/\$/\$\$/g')

                # Update RCON_PASSWORD line in docker-compose.yml
                sed -i "s|RCON_PASSWORD:.*|RCON_PASSWORD: \"${ESCAPED_RCON_PASSWORD}\"|" docker-compose.yml
                echo "âœ“ docker-compose.yml updated with escaped password"
              else
                echo "âš  docker-compose.yml not found at $DEPLOY_DIR"
              fi
              echo ""

              # Step 4: Force recreate Minecraft server container
              echo "Step 4: Recreating Minecraft server container to apply new password..."
              cd "$DEPLOY_DIR"
              docker compose up -d --force-recreate minecraft-server

              echo "Waiting for Minecraft server to become healthy..."
              for i in $(seq 1 60); do
                HEALTH=$(docker inspect --format='{{.State.Health.Status}}' minecraft-server 2>/dev/null || echo "starting")
                if [ "$HEALTH" = "healthy" ]; then
                  echo "âœ“ Minecraft server is healthy"
                  break
                fi
                echo "  Status: $HEALTH (attempt $i/60)"
                sleep 2
              done
              echo ""

              # Step 5: Force recreate Console container
              echo "Step 5: Recreating Console container to apply new password..."
              cd "$CONSOLE_DIR"
              docker compose up -d --force-recreate minecraft-console

              echo "Waiting for console to become healthy..."
              for i in $(seq 1 30); do
                HEALTH=$(docker inspect --format='{{.State.Health.Status}}' minecraft-console 2>/dev/null || echo "starting")
                if [ "$HEALTH" = "healthy" ]; then
                  echo "âœ“ Console is healthy"
                  break
                fi
                echo "  Status: $HEALTH (attempt $i/30)"
                sleep 2
              done
              echo ""

              echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
              echo "â•‘  PASSWORD SYNCHRONIZATION COMPLETE                     â•‘"
              echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
              echo ""
            }

            # Main execution based on action
            case "${ACTION}" in
              diagnose)
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                echo "RUNNING DIAGNOSTICS MODE"
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                echo ""

                run_diagnostics "pre-fix"

                echo ""
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                echo "DIAGNOSTICS COMPLETE"
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                echo ""
                echo "All diagnostic files have been saved to: $DIAGNOSTICS_DIR"
                echo ""
                echo "Next steps:"
                echo "  - Review the output above for any âœ— or âš  indicators"
                echo "  - Check password hash mismatches in Section 9"
                echo "  - If passwords don't match, run this workflow with action='fix'"
                echo "  - Download diagnostics directory for offline analysis:"
                echo "    scp -r ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:$DIAGNOSTICS_DIR ."
                ;;

              fix)
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                echo "RUNNING FIX MODE"
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                echo ""

                echo "Phase 1: Pre-fix diagnostics..."
                run_diagnostics "pre-fix"
                echo ""

                echo "Phase 2: Synchronizing passwords..."
                sync_passwords
                echo ""

                echo "Phase 3: Post-fix diagnostics and verification..."
                run_diagnostics "post-fix"
                echo ""

                echo "Phase 4: Verification test..."
                cd "$DEPLOY_DIR"
                echo "Testing RCON command execution..."
                if docker exec minecraft-server rcon-cli list 2>&1; then
                  echo ""
                  echo "âœ“âœ“âœ“ SUCCESS! RCON is working correctly! âœ“âœ“âœ“"
                else
                  echo ""
                  echo "âš âš âš  WARNING: RCON test failed after fix âš âš âš "
                  echo "Check the logs above for errors."
                fi
                echo ""

                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                echo "FIX COMPLETE"
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                echo ""
                echo "All diagnostic files (pre and post fix) saved to: $DIAGNOSTICS_DIR"
                echo ""
                echo "What was changed:"
                echo "  âœ“ Server .env updated with new RCON_PASSWORD"
                echo "  âœ“ Console .env updated with new RCON_PASSWORD"
                echo "  âœ“ Server docker-compose.yml updated (with escaped password)"
                echo "  âœ“ Both containers recreated to apply changes"
                echo ""
                echo "Next steps:"
                echo "  - Review the post-fix diagnostics above"
                echo "  - Verify RCON connectivity from console UI"
                echo "  - Test console commands work correctly"
                echo "  - Download diagnostics for records:"
                echo "    scp -r ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:$DIAGNOSTICS_DIR ."
                ;;

              *)
                echo "âœ— Unknown action: ${ACTION}"
                echo "Valid actions: diagnose, fix"
                exit 1
                ;;
            esac

            # Create a summary file
            {
              echo "ULTIMATE RCON SYNC & DIAGNOSTICS - SUMMARY"
              echo "=========================================="
              echo ""
              echo "Timestamp: $(date)"
              echo "Action: ${ACTION}"
              echo "Diagnostics directory: $DIAGNOSTICS_DIR"
              echo ""
              echo "Files created:"
              ls -lh "$DIAGNOSTICS_DIR" 2>/dev/null | tail -n +2 || echo "No files created"
              echo ""
              echo "Total size:"
              du -sh "$DIAGNOSTICS_DIR" 2>/dev/null || echo "N/A"
            } | tee "${DIAGNOSTICS_DIR}/SUMMARY.txt"

            echo ""
            echo "============================================================"
            echo "To download all diagnostics for offline review or analysis:"
            echo "  scp -r ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:$DIAGNOSTICS_DIR ."
            echo "============================================================"

      - name: Create diagnostics summary
        if: always()
        run: |
          ACTION="${{ github.event.inputs.action }}"
          {
            echo "## Ultimate RCON Sync & Diagnostics ðŸ”§"
            echo ""
            echo "**Action performed:** \`${ACTION}\`"
            echo "**Timestamp:** $(date)"
            echo ""

            if [ "$ACTION" = "diagnose" ]; then
              echo "### Diagnostics Mode"
              echo ""
              echo "A comprehensive diagnostic report has been generated covering:"
              echo "- âœ… Docker Compose configurations"
              echo "- âœ… Container environment variables"
              echo "- âœ… .env and server.properties files"
              echo "- âœ… Docker volume mounts"
              echo "- âœ… Container logs (100 lines each)"
              echo "- âœ… Network TCP connectivity tests"
              echo "- âœ… RCON command tests (rcon-cli and Node)"
              echo "- âœ… RCON-related log entries"
              echo "- âœ… Password hash analysis (SHA256, MD5, length)"
              echo "- âœ… Container status summary"
              echo ""
              echo "### Next Steps"
              echo ""
              echo "1. **Review the workflow logs** for any âœ— or âš  indicators"
              echo "2. **Check Section 9 (Password Analysis)** for hash mismatches"
              echo "3. **If passwords don't match:** Run this workflow again with action='fix'"
              echo "4. **Download diagnostics** for offline review or to attach to support requests"
              echo ""
              echo "### Downloading Diagnostics"
              echo ""
              echo "\`\`\`bash"
              echo "# Check the workflow logs for the diagnostics directory path, then:"
              echo "scp -r ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/tmp/rcon-diagnostics-* ."
              echo "\`\`\`"
              echo ""

            elif [ "$ACTION" = "fix" ]; then
              echo "### Fix Mode - Password Synchronization"
              echo ""
              echo "The following actions were performed:"
              echo "1. âœ… **Pre-fix diagnostics** captured"
              echo "2. âœ… **Server .env** updated with RCON_PASSWORD"
              echo "3. âœ… **Console .env** updated with RCON_PASSWORD"
              echo "4. âœ… **docker-compose.yml** updated (password escaped for Docker Compose)"
              echo "5. âœ… **Minecraft server container** recreated (--force-recreate)"
              echo "6. âœ… **Console container** recreated (--force-recreate)"
              echo "7. âœ… **Post-fix diagnostics** captured"
              echo "8. âœ… **RCON command test** executed"
              echo ""
              echo "### Verification"
              echo ""
              echo "Check the workflow logs above for the final RCON test result."
              echo ""
              echo "- **If test passed:** ðŸŽ‰ RCON is now working correctly!"
              echo "- **If test failed:** Review the post-fix diagnostics in the logs"
              echo ""
              echo "### What Changed"
              echo ""
              echo "The RCON_PASSWORD has been synchronized across:"
              echo "- GitHub secret/input â†’ Server .env"
              echo "- GitHub secret/input â†’ Console .env"
              echo "- GitHub secret/input â†’ docker-compose.yml (escaped)"
              echo "- Containers recreated to apply environment variables"
              echo "- Server.properties will be updated by itzg/minecraft-server on container start (via OVERRIDE_SERVER_PROPERTIES)"
              echo ""
              echo "### Next Steps"
              echo ""
              echo "1. **Test console UI** - Verify RCON commands work from the web console"
              echo "2. **Monitor logs** - Check for any authentication errors"
              echo "3. **Download diagnostics** for your records:"
              echo ""
              echo "\`\`\`bash"
              echo "# Check the workflow logs for the diagnostics directory path, then:"
              echo "scp -r ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/tmp/rcon-diagnostics-* ."
              echo "\`\`\`"
              echo ""
            fi

            echo "### Security Note"
            echo ""
            echo "All password values are redacted in diagnostics output."
            echo "Only hashes (SHA256, MD5) and lengths are shown for comparison."
            echo ""
            echo "---"
            echo ""
            echo "**Need help?** Review the diagnostics output above or download the complete diagnostics package for detailed analysis."
          } >> "$GITHUB_STEP_SUMMARY"
