name: Deploy Minecraft Server

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allows manual triggering
    inputs:
      install_plugins:
        description: 'Install/update plugins during deployment'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
        
    - name: Deploy to Hetzner Server
      env:
        SERVER_HOST: ${{ secrets.SERVER_HOST }}
        SERVER_USER: ${{ secrets.SERVER_USER }}
        RCON_PASSWORD: ${{ secrets.RCON_PASSWORD }}
      run: |
        # Create server directory on remote server
        ssh ${SERVER_USER}@${SERVER_HOST} "mkdir -p /home/deploy/minecraft-server"
        
        # Copy configuration files
        scp config.sh ${SERVER_USER}@${SERVER_HOST}:/home/deploy/minecraft-server/
        scp server.properties ${SERVER_USER}@${SERVER_HOST}:/home/deploy/minecraft-server/
        
        # Inject RCON password from secret (keeps sensitive data out of repo)
        ssh ${SERVER_USER}@${SERVER_HOST} "awk -v pwd=\"\${RCON_PASSWORD}\" '/^rcon\\.password=/ {print \"rcon.password=\" pwd; next} {print}' /home/deploy/minecraft-server/server.properties > /tmp/server.properties.tmp && mv /tmp/server.properties.tmp /home/deploy/minecraft-server/server.properties"
        
        scp eula.txt ${SERVER_USER}@${SERVER_HOST}:/home/deploy/minecraft-server/
        scp start.sh ${SERVER_USER}@${SERVER_HOST}:/home/deploy/minecraft-server/
        scp backup.sh ${SERVER_USER}@${SERVER_HOST}:/home/deploy/minecraft-server/
        scp update.sh ${SERVER_USER}@${SERVER_HOST}:/home/deploy/minecraft-server/
        
        # Copy plugin installation files
        scp plugins.json ${SERVER_USER}@${SERVER_HOST}:/home/deploy/minecraft-server/
        scp install-plugins.sh ${SERVER_USER}@${SERVER_HOST}:/home/deploy/minecraft-server/
        scp update-plugins.sh ${SERVER_USER}@${SERVER_HOST}:/home/deploy/minecraft-server/
        
        # Make scripts executable
        ssh ${SERVER_USER}@${SERVER_HOST} "chmod +x /home/deploy/minecraft-server/*.sh"
        
        # Copy and setup systemd service
        scp minecraft.service ${SERVER_USER}@${SERVER_HOST}:/tmp/
        ssh ${SERVER_USER}@${SERVER_HOST} "sudo mv /tmp/minecraft.service /etc/systemd/system/ && sudo systemctl daemon-reload"
        
    - name: Download Minecraft Server JAR
      env:
        SERVER_HOST: ${{ secrets.SERVER_HOST }}
        SERVER_USER: ${{ secrets.SERVER_USER }}
      run: |
        ssh ${SERVER_USER}@${SERVER_HOST} << 'EOF'
          cd /home/deploy/minecraft-server
          # Load configuration
          if [ -f "config.sh" ]; then
            source config.sh
          else
            MINECRAFT_VERSION="1.20.4"
          fi
          
          if [ ! -f "server.jar" ]; then
            echo "Downloading Paper server for Minecraft version ${MINECRAFT_VERSION}..."
            
            # Get the latest Paper build for the specified Minecraft version
            # Use jq if available for better JSON parsing, otherwise use grep
            if command -v jq &> /dev/null; then
              PAPER_BUILD=$(curl -s "https://api.papermc.io/v2/projects/paper/versions/${MINECRAFT_VERSION}" | jq -r '.builds[-1]')
            else
              # Fallback to grep-based parsing
              PAPER_BUILD=$(curl -s "https://api.papermc.io/v2/projects/paper/versions/${MINECRAFT_VERSION}" | grep -oP '(?<="builds":\[)[0-9,]+(?=\])' | tr ',' '\n' | tail -1)
            fi
            
            if [ -z "$PAPER_BUILD" ] || [ "$PAPER_BUILD" = "null" ]; then
              echo "Error: Could not fetch Paper build information for version ${MINECRAFT_VERSION}"
              echo "Please verify the version is available at https://papermc.io/downloads"
              exit 1
            fi
            
            echo "Latest Paper build for ${MINECRAFT_VERSION}: ${PAPER_BUILD}"
            PAPER_JAR_URL="https://api.papermc.io/v2/projects/paper/versions/${MINECRAFT_VERSION}/builds/${PAPER_BUILD}/downloads/paper-${MINECRAFT_VERSION}-${PAPER_BUILD}.jar"
            
            curl -f -o server.jar "$PAPER_JAR_URL" || {
              echo "Failed to download Paper server JAR"
              echo "URL: ${PAPER_JAR_URL}"
              exit 1
            }
            echo "Paper server download completed successfully"
          fi
        EOF
        
    - name: Install/Update Plugins
      if: github.event.inputs.install_plugins == 'true'
      env:
        SERVER_HOST: ${{ secrets.SERVER_HOST }}
        SERVER_USER: ${{ secrets.SERVER_USER }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        ssh ${SERVER_USER}@${SERVER_HOST} << EOF
          cd /home/deploy/minecraft-server
          
          # Export GitHub token for use by install-plugins.sh
          export GITHUB_TOKEN="${GITHUB_TOKEN}"
          
          # Check if jq is installed
          if ! command -v jq &> /dev/null; then
            echo "jq is not installed. Installing..."
            sudo apt update && sudo apt install -y jq
          fi
          
          # Run plugin installation script
          if [ -f "install-plugins.sh" ]; then
            echo "Installing/updating plugins..."
            ./install-plugins.sh --update
          else
            echo "install-plugins.sh not found, skipping plugin installation"
          fi
        EOF
        
    - name: Restart Minecraft Service
      env:
        SERVER_HOST: ${{ secrets.SERVER_HOST }}
        SERVER_USER: ${{ secrets.SERVER_USER }}
      run: |
        ssh ${SERVER_USER}@${SERVER_HOST} << 'EOF'
          # Check if service exists and is enabled
          if systemctl is-enabled minecraft.service >/dev/null 2>&1; then
            sudo systemctl restart minecraft.service
          else
            echo "Service not enabled. Enable it manually with: sudo systemctl enable --now minecraft.service"
          fi
        EOF
        
    - name: Check Server Status
      env:
        SERVER_HOST: ${{ secrets.SERVER_HOST }}
        SERVER_USER: ${{ secrets.SERVER_USER }}
      run: |
        ssh ${SERVER_USER}@${SERVER_HOST} "systemctl status minecraft.service --no-pager" || true
