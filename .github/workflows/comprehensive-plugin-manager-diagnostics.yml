# Comprehensive Plugin Manager Diagnostics Workflow (v2.0)
#
# This workflow combines all diagnostic tools into a single coordinated run:
# - Browser diagnostics (Puppeteer automation)
# - Backend/plugin diagnostics (plugin manager checks)
# - API profiling (endpoint performance testing)
# - Resource monitoring (CPU, memory, Docker stats)
# - Secrets requirements documentation
#
# âœ… FULLY SELF-DISPATCHABLE - Run from GitHub Actions UI without any manual changes!
# âœ… NO SECRET-DEPENDENT IF CONDITIONS - Uses runtime detection instead
# âœ… GRACEFUL FALLBACK - Missing secrets skip steps with clear explanations
# âœ… COMPREHENSIVE REPORTING - Includes secrets usage and requirements documentation
#
# WHEN TO USE:
# - Complex issues where root cause is unclear
# - Production health checks / post-deployment validation
# - Performance issues
# - Complete system diagnostics
#
# WHAT YOU GET:
# - Master summary with rapid triage guide
# - Individual artifacts for each diagnostic type
# - Cross-referenced findings
# - Actionable debugging recommendations
# - Secrets requirements and usage documentation
# - Step-by-step guide for enabling full diagnostics
#
# HOW TO USE:
# 1. Go to Actions â†’ Comprehensive Plugin Manager Diagnostics
# 2. Click "Run workflow"
# 3. Configure options (or use defaults)
# 4. Review artifacts starting with comprehensive-summary
#
# See docs/DIAGNOSTICS-GUIDE.md for detailed documentation

name: Comprehensive Plugin Manager Diagnostics

on:
  workflow_dispatch:
    inputs:
      console_url:
        description: 'Console URL to test (defaults to deployed console)'
        required: false
        type: string

      # Feature toggles
      run_browser_diagnostics:
        description: 'Run browser-based diagnostics (Puppeteer)'
        required: true
        type: boolean
        default: true

      run_backend_diagnostics:
        description: 'Run backend/plugin diagnostics'
        required: true
        type: boolean
        default: true

      run_api_profiling:
        description: 'Run API endpoint profiling'
        required: true
        type: boolean
        default: true

      run_resource_monitoring:
        description: 'Run resource monitoring (CPU, memory, Docker)'
        required: true
        type: boolean
        default: true

      # Backend diagnostics options
      backend_mode:
        description: 'Backend diagnostic mode (diagnose or fix)'
        required: true
        type: choice
        options:
          - diagnose
          - fix
        default: diagnose

      run_advanced_backend:
        description: 'Run advanced backend diagnostics'
        required: true
        type: boolean
        default: true

      # Browser options
      headless:
        description: 'Run browser in headless mode'
        required: true
        type: boolean
        default: true

      # Resource monitoring options
      monitor_duration:
        description: 'Resource monitoring duration (seconds)'
        required: true
        type: number
        default: 90

      monitor_interval:
        description: 'Resource monitoring sample interval (seconds)'
        required: true
        type: number
        default: 2

jobs:
  comprehensive-diagnostics:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      actions: write

    env:
      DEPLOY_DIR: /home/deploy/minecraft-server
      CONSOLE_DIR: /home/deploy/minecraft-console
      RUN_NUMBER: ${{ github.run_number }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Detect and document available secrets
        id: secrets_check
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘           DETECTING AVAILABLE SECRETS                          â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

          # Check each secret and set flags
          # Use shell logic instead of GitHub's secrets context in if conditions

          HAS_SERVER_HOST="false"
          HAS_SERVER_USER="false"
          HAS_SSH_KEY="false"
          HAS_CONSOLE_USER="false"
          HAS_CONSOLE_PASS="false"

          # Check SERVER_HOST
          if [ -n "${{ secrets.SERVER_HOST }}" ]; then
            echo "âœ“ SERVER_HOST is configured"
            HAS_SERVER_HOST="true"
          else
            echo "âœ— SERVER_HOST is NOT configured"
          fi

          # Check SERVER_USER
          if [ -n "${{ secrets.SERVER_USER }}" ]; then
            echo "âœ“ SERVER_USER is configured"
            HAS_SERVER_USER="true"
          else
            echo "âœ— SERVER_USER is NOT configured"
          fi

          # Check SSH_PRIVATE_KEY
          if [ -n "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "âœ“ SSH_PRIVATE_KEY is configured"
            HAS_SSH_KEY="true"
          else
            echo "âœ— SSH_PRIVATE_KEY is NOT configured"
          fi

          # Check CONSOLE_ADMIN_USER
          if [ -n "${{ secrets.CONSOLE_ADMIN_USER }}" ]; then
            echo "âœ“ CONSOLE_ADMIN_USER is configured"
            HAS_CONSOLE_USER="true"
          else
            echo "âœ— CONSOLE_ADMIN_USER is NOT configured (will use default: admin)"
          fi

          # Check CONSOLE_ADMIN_PASSWORD
          if [ -n "${{ secrets.CONSOLE_ADMIN_PASSWORD }}" ]; then
            echo "âœ“ CONSOLE_ADMIN_PASSWORD is configured"
            HAS_CONSOLE_PASS="true"
          else
            echo "âœ— CONSOLE_ADMIN_PASSWORD is NOT configured (will use default: admin)"
          fi

          echo ""
          echo "Setting output flags for conditional steps..."
          echo "has_server_host=$HAS_SERVER_HOST" >> $GITHUB_OUTPUT
          echo "has_server_user=$HAS_SERVER_USER" >> $GITHUB_OUTPUT
          echo "has_ssh_key=$HAS_SSH_KEY" >> $GITHUB_OUTPUT
          echo "has_console_user=$HAS_CONSOLE_USER" >> $GITHUB_OUTPUT
          echo "has_console_pass=$HAS_CONSOLE_PASS" >> $GITHUB_OUTPUT

          # Determine if we can do remote diagnostics
          if [ "$HAS_SERVER_HOST" = "true" ] && [ "$HAS_SERVER_USER" = "true" ] && [ "$HAS_SSH_KEY" = "true" ]; then
            echo "can_ssh=true" >> $GITHUB_OUTPUT
            echo ""
            echo "âœ“ Remote diagnostics ENABLED (SSH access available)"
          else
            echo "can_ssh=false" >> $GITHUB_OUTPUT
            echo ""
            echo "âœ— Remote diagnostics DISABLED (missing SSH credentials)"
            echo "  Required: SERVER_HOST, SERVER_USER, SSH_PRIVATE_KEY"
          fi

          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘           SECRET DETECTION COMPLETE                            â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: Setup Node.js
        if: github.event.inputs.run_browser_diagnostics == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Puppeteer dependencies
        if: github.event.inputs.run_browser_diagnostics == 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libnss3 \
            libnspr4 \
            libatk1.0-0 \
            libatk-bridge2.0-0 \
            libcups2 \
            libdrm2 \
            libdbus-1-3 \
            libxkbcommon0 \
            libxcomposite1 \
            libxdamage1 \
            libxfixes3 \
            libxrandr2 \
            libgbm1 \
            libasound2 \
            libpango-1.0-0 \
            libcairo2

      - name: Install Puppeteer
        if: github.event.inputs.run_browser_diagnostics == 'true'
        run: |
          cd console/backend
          npm install puppeteer@21.6.1

      - name: Determine console URL
        id: console_url
        run: |
          if [ -n "${{ github.event.inputs.console_url }}" ]; then
            echo "url=${{ github.event.inputs.console_url }}" >> $GITHUB_OUTPUT
          else
            # Use deployed console URL (construct from secrets if available)
            if [ -n "${{ secrets.SERVER_HOST }}" ]; then
              echo "url=https://${{ secrets.SERVER_HOST }}/console" >> $GITHUB_OUTPUT
            else
              echo "url=http://localhost:3000" >> $GITHUB_OUTPUT
            fi
          fi

          echo "Console URL: $(grep url "$GITHUB_OUTPUT" | cut -d'=' -f2-)"

      - name: Setup SSH (if testing deployed console)
        if: steps.secrets_check.outputs.can_ssh == 'true'
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      # ========================================================================
      # RESOURCE MONITORING - Start monitoring early to capture all activity
      # ========================================================================
      - name: Start resource monitoring
        if: github.event.inputs.run_resource_monitoring == 'true' && steps.secrets_check.outputs.can_ssh == 'true'
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘               STARTING RESOURCE MONITORING                     â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

          ssh -i ~/.ssh/id_rsa ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            # Configure resource monitor
            export OUTPUT_DIR=/tmp/comprehensive-diagnostics-resources-${{ github.run_number }}
            export MONITOR_DURATION=${{ github.event.inputs.monitor_duration }}
            export MONITOR_INTERVAL=${{ github.event.inputs.monitor_interval }}
            export CONTAINER_NAME=minecraft-console

            # Create scripts directory
            mkdir -p /tmp/scripts
          EOF

          # Upload resource monitor script
          scp -i ~/.ssh/id_rsa scripts/resource-monitor.sh \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/tmp/scripts/

          ssh -i ~/.ssh/id_rsa ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            chmod +x /tmp/scripts/resource-monitor.sh

            # Run in background
            nohup /tmp/scripts/resource-monitor.sh > /tmp/resource-monitor-${{ github.run_number }}.log 2>&1 &
            echo $! > /tmp/resource-monitor-${{ github.run_number }}.pid

            echo "âœ“ Resource monitoring started (PID: $(cat /tmp/resource-monitor-${{ github.run_number }}.pid))"
          EOF

      - name: Resource monitoring skipped (SSH not available)
        if: github.event.inputs.run_resource_monitoring == 'true' && steps.secrets_check.outputs.can_ssh != 'true'
        run: |
          echo "âš ï¸ Resource monitoring requires SSH access to remote server"
          echo "   Missing secrets: SERVER_HOST, SERVER_USER, and/or SSH_PRIVATE_KEY"
          echo "   This step has been skipped - see final summary for how to enable"

      # ========================================================================
      # BACKEND DIAGNOSTICS - Run plugin manager diagnostics
      # ========================================================================
      - name: Upload diagnostic scripts to server
        if: github.event.inputs.run_backend_diagnostics == 'true' && steps.secrets_check.outputs.can_ssh == 'true'
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘               BACKEND DIAGNOSTICS SETUP                        â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

          echo "Uploading diagnostic scripts..."
          scp -i ~/.ssh/id_rsa \
            scripts/diagnose-plugins.sh \
            scripts/diagnose-plugins-advanced.sh \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ env.DEPLOY_DIR }}/scripts/

          echo "Setting executable permissions..."
          ssh -i ~/.ssh/id_rsa ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            chmod +x ${{ env.DEPLOY_DIR }}/scripts/diagnose-plugins.sh
            chmod +x ${{ env.DEPLOY_DIR }}/scripts/diagnose-plugins-advanced.sh
          EOF

          echo "âœ“ Diagnostic scripts uploaded"

      - name: Run basic backend diagnostics
        if: github.event.inputs.run_backend_diagnostics == 'true' && steps.secrets_check.outputs.can_ssh == 'true'
        id: basic_backend_diagnostics
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘            RUNNING BASIC BACKEND DIAGNOSTICS                   â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Mode: ${{ github.event.inputs.backend_mode }}"
          echo ""

          # Run diagnostics and capture fix count
          FIX_COUNT=$(ssh -i ~/.ssh/id_rsa ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            cd ${{ env.DEPLOY_DIR }}

            # Run basic diagnostics
            ./scripts/diagnose-plugins.sh ${{ github.event.inputs.backend_mode }} || true

            # Find the most recent diagnostics directory and count fixes
            DIAG_DIR=$(ls -td /tmp/plugin-diagnostics-* 2>/dev/null | grep -v advanced | head -1)

            if [ -n "$DIAG_DIR" ] && [ -f "$DIAG_DIR/fixes.log" ]; then
              wc -l < "$DIAG_DIR/fixes.log"
            else
              echo "0"
            fi
          EOF
          )

          echo "fixes_applied=$FIX_COUNT" >> $GITHUB_OUTPUT
          echo "âœ“ Basic diagnostics completed. Fixes applied: $FIX_COUNT"

      - name: Run advanced backend diagnostics
        if: github.event.inputs.run_backend_diagnostics == 'true' && github.event.inputs.run_advanced_backend == 'true' && steps.secrets_check.outputs.can_ssh == 'true'
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘           RUNNING ADVANCED BACKEND DIAGNOSTICS                 â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

          ssh -i ~/.ssh/id_rsa ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            cd ${{ env.DEPLOY_DIR }}

            # Run advanced diagnostics
            ./scripts/diagnose-plugins-advanced.sh || true
          EOF

          echo "âœ“ Advanced diagnostics completed"

      - name: Backend diagnostics skipped (SSH not available)
        if: github.event.inputs.run_backend_diagnostics == 'true' && steps.secrets_check.outputs.can_ssh != 'true'
        run: |
          echo "âš ï¸ Backend diagnostics require SSH access to remote server"
          echo "   Missing secrets: SERVER_HOST, SERVER_USER, and/or SSH_PRIVATE_KEY"
          echo "   This step has been skipped - see final summary for how to enable"

      # ========================================================================
      # BROWSER DIAGNOSTICS - Automated browser testing
      # ========================================================================
      - name: Run browser diagnostics
        if: github.event.inputs.run_browser_diagnostics == 'true'
        env:
          CONSOLE_URL: ${{ steps.console_url.outputs.url }}
          ADMIN_USERNAME: ${{ secrets.CONSOLE_ADMIN_USER || 'admin' }}
          ADMIN_PASSWORD: ${{ secrets.CONSOLE_ADMIN_PASSWORD || 'admin' }}
          OUTPUT_DIR: /tmp/comprehensive-browser-diagnostics-${{ github.run_number }}
          HEADLESS: ${{ github.event.inputs.headless }}
          TIMEOUT: 30000
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                 BROWSER DIAGNOSTICS                            â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Console URL: ${CONSOLE_URL}"
          echo "Headless mode: ${HEADLESS}"
          echo ""

          # Run browser diagnostics and capture exit code
          EXIT_CODE=0
          node scripts/browser-diagnostics.js || EXIT_CODE=$?

          # List generated files
          echo ""
          echo "Generated diagnostic files:"
          ls -lh /tmp/comprehensive-browser-diagnostics-${{ github.run_number }}/ || echo "No files generated"

          # Exit with error if diagnostics failed critically (exit code > 1)
          # Exit code 1 is acceptable (errors found but diagnostics completed)
          # Exit code > 1 indicates script failure
          if [ $EXIT_CODE -gt 1 ]; then
            echo "âœ— Browser diagnostics failed with exit code $EXIT_CODE"
            exit $EXIT_CODE
          fi

          echo "âœ“ Browser diagnostics completed (exit code: $EXIT_CODE)"

      # ========================================================================
      # API PROFILING - Comprehensive API endpoint testing
      # ========================================================================
      - name: Run API profiling
        if: github.event.inputs.run_api_profiling == 'true'
        env:
          CONSOLE_URL: ${{ steps.console_url.outputs.url }}
          ADMIN_USERNAME: ${{ secrets.CONSOLE_ADMIN_USER || 'admin' }}
          ADMIN_PASSWORD: ${{ secrets.CONSOLE_ADMIN_PASSWORD || 'admin' }}
          OUTPUT_DIR: /tmp/comprehensive-api-profiler-${{ github.run_number }}
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                   API PROFILING                                â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

          chmod +x scripts/api-profiler.sh
          scripts/api-profiler.sh || true

          # List generated files
          echo ""
          echo "Generated API profiling files:"
          ls -lh /tmp/comprehensive-api-profiler-${{ github.run_number }}/ || echo "No files generated"

          echo "âœ“ API profiling completed"

      # ========================================================================
      # STOP RESOURCE MONITORING - Collect results
      # ========================================================================
      - name: Stop resource monitoring and download results
        if: always() && github.event.inputs.run_resource_monitoring == 'true' && steps.secrets_check.outputs.can_ssh == 'true'
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘          STOPPING RESOURCE MONITORING                          â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

          # Give it a moment to finish current cycle
          sleep 5

          ssh -i ~/.ssh/id_rsa ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            # Stop monitoring if still running
            if [ -f /tmp/resource-monitor-${{ github.run_number }}.pid ]; then
              PID=$(cat /tmp/resource-monitor-${{ github.run_number }}.pid)
              if ps -p $PID > /dev/null 2>&1; then
                echo "Stopping resource monitor (PID: $PID)"
                kill $PID 2>/dev/null || true
                sleep 2
              fi
            fi

            # Create tarball if data exists
            if [ -d /tmp/comprehensive-diagnostics-resources-${{ github.run_number }} ]; then
              cd /tmp
              tar -czf comprehensive-diagnostics-resources-${{ github.run_number }}.tar.gz \
                comprehensive-diagnostics-resources-${{ github.run_number }}/
              echo "âœ“ Resource monitoring data archived"
            fi
          EOF

          # Download the tarball
          scp -i ~/.ssh/id_rsa \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/tmp/comprehensive-diagnostics-resources-${{ github.run_number }}.tar.gz \
            ./comprehensive-diagnostics-resources.tar.gz || echo "âš  No resource monitoring data to download"

          # Extract if downloaded
          if [ -f ./comprehensive-diagnostics-resources.tar.gz ]; then
            mkdir -p ./diagnostics-resources
            tar -xzf ./comprehensive-diagnostics-resources.tar.gz -C ./diagnostics-resources
            echo "âœ“ Resource monitoring data downloaded and extracted"
          fi

      # ========================================================================
      # DOWNLOAD BACKEND DIAGNOSTICS
      # ========================================================================
      - name: Download basic backend diagnostic reports
        if: always() && github.event.inputs.run_backend_diagnostics == 'true' && steps.secrets_check.outputs.can_ssh == 'true'
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘         DOWNLOADING BACKEND DIAGNOSTIC REPORTS                 â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

          ssh -i ~/.ssh/id_rsa ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            # Find most recent basic diagnostics directory
            DIAG_DIR=$(ls -td /tmp/plugin-diagnostics-* 2>/dev/null | grep -v "advanced" | head -1)

            if [ -n "$DIAG_DIR" ]; then
              # Create tarball of diagnostics
              tar -czf /tmp/plugin-diagnostics-basic-${{ github.run_number }}.tar.gz -C "$(dirname "$DIAG_DIR")" "$(basename "$DIAG_DIR")"
              echo "âœ“ Created basic diagnostics archive"
            else
              echo "âš  No basic diagnostics directory found"
            fi
          EOF

          # Download the tarball
          scp -i ~/.ssh/id_rsa \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/tmp/plugin-diagnostics-basic-${{ github.run_number }}.tar.gz \
            ./plugin-diagnostics-basic.tar.gz || echo "âš  Failed to download basic diagnostics"

          # Extract for artifact upload
          if [ -f ./plugin-diagnostics-basic.tar.gz ]; then
            mkdir -p ./diagnostics-backend-basic
            tar -xzf ./plugin-diagnostics-basic.tar.gz -C ./diagnostics-backend-basic
            echo "âœ“ Basic backend diagnostics downloaded"
          fi

      - name: Download advanced backend diagnostic reports
        if: always() && github.event.inputs.run_backend_diagnostics == 'true' && github.event.inputs.run_advanced_backend == 'true' && steps.secrets_check.outputs.can_ssh == 'true'
        run: |
          echo "Downloading advanced backend diagnostic reports..."

          ssh -i ~/.ssh/id_rsa ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            # Find most recent advanced diagnostics directory
            ADV_DIAG_DIR=$(ls -td /tmp/plugin-diagnostics-advanced-* 2>/dev/null | head -1)

            if [ -n "$ADV_DIAG_DIR" ]; then
              # Create tarball of diagnostics
              tar -czf /tmp/plugin-diagnostics-advanced-${{ github.run_number }}.tar.gz -C "$(dirname "$ADV_DIAG_DIR")" "$(basename "$ADV_DIAG_DIR")"
              echo "âœ“ Created advanced diagnostics archive"
            else
              echo "âš  No advanced diagnostics directory found"
            fi
          EOF

          # Download the tarball
          scp -i ~/.ssh/id_rsa \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/tmp/plugin-diagnostics-advanced-${{ github.run_number }}.tar.gz \
            ./plugin-diagnostics-advanced.tar.gz || echo "âš  Failed to download advanced diagnostics"

          # Extract for artifact upload
          if [ -f ./plugin-diagnostics-advanced.tar.gz ]; then
            mkdir -p ./diagnostics-backend-advanced
            tar -xzf ./plugin-diagnostics-advanced.tar.gz -C ./diagnostics-backend-advanced
            echo "âœ“ Advanced backend diagnostics downloaded"
          fi

      # ========================================================================
      # MASTER AGGREGATION AND SUMMARY
      # ========================================================================
      - name: Generate comprehensive master summary
        if: always()
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘           GENERATING MASTER SUMMARY                            â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

          mkdir -p ./comprehensive-summary

          {
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘  COMPREHENSIVE PLUGIN MANAGER DIAGNOSTICS - MASTER SUMMARY     â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "Generated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo "Workflow Run: #${{ github.run_number }}"
            echo "Console URL: ${{ steps.console_url.outputs.url }}"
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "DIAGNOSTIC COMPONENTS EXECUTED"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""

            if [ "${{ github.event.inputs.run_browser_diagnostics }}" = "true" ]; then
              echo "âœ“ Browser Automation Diagnostics (Puppeteer)"
            else
              echo "â—‹ Browser Automation Diagnostics (skipped)"
            fi

            if [ "${{ github.event.inputs.run_backend_diagnostics }}" = "true" ]; then
              echo "âœ“ Backend/Plugin Diagnostics (mode: ${{ github.event.inputs.backend_mode }})"
              if [ "${{ github.event.inputs.run_advanced_backend }}" = "true" ]; then
                echo "  âœ“ Advanced backend diagnostics"
              fi
            else
              echo "â—‹ Backend/Plugin Diagnostics (skipped)"
            fi

            if [ "${{ github.event.inputs.run_api_profiling }}" = "true" ]; then
              echo "âœ“ API Endpoint Profiling"
            else
              echo "â—‹ API Endpoint Profiling (skipped)"
            fi

            if [ "${{ github.event.inputs.run_resource_monitoring }}" = "true" ]; then
              echo "âœ“ Resource Monitoring (CPU, Memory, Docker)"
              echo "  Duration: ${{ github.event.inputs.monitor_duration }}s"
              echo "  Interval: ${{ github.event.inputs.monitor_interval }}s"
            else
              echo "â—‹ Resource Monitoring (skipped)"
            fi

            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "DIAGNOSTIC RESULTS SUMMARY"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""

            # Browser diagnostics summary
            if [ -f /tmp/comprehensive-browser-diagnostics-${{ github.run_number }}/SUMMARY.txt ]; then
              echo "â”Œâ”€ BROWSER DIAGNOSTICS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
              cat /tmp/comprehensive-browser-diagnostics-${{ github.run_number }}/SUMMARY.txt
              echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
              echo ""
            fi

            # Backend diagnostics summary
            if [ -d ./diagnostics-backend-basic ]; then
              SUMMARY_FILE=$(find ./diagnostics-backend-basic -name "summary.log" | head -1)
              if [ -f "$SUMMARY_FILE" ]; then
                echo "â”Œâ”€ BACKEND DIAGNOSTICS (BASIC) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
                cat "$SUMMARY_FILE"
                echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
                echo ""
              fi

              # Show issues if any
              ISSUES_FILE=$(find ./diagnostics-backend-basic -name "issues.log" | head -1)
              if [ -f "$ISSUES_FILE" ] && [ -s "$ISSUES_FILE" ]; then
                echo "â”Œâ”€ BACKEND ISSUES FOUND â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
                cat "$ISSUES_FILE"
                echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
                echo ""
              fi

              # Show fixes if any
              FIXES_FILE=$(find ./diagnostics-backend-basic -name "fixes.log" | head -1)
              if [ -f "$FIXES_FILE" ] && [ -s "$FIXES_FILE" ]; then
                echo "â”Œâ”€ BACKEND AUTO-FIXES APPLIED â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
                cat "$FIXES_FILE"
                echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
                echo ""
              fi
            fi

            # Advanced backend diagnostics summary
            if [ -d ./diagnostics-backend-advanced ]; then
              ADV_SUMMARY_FILE=$(find ./diagnostics-backend-advanced -name "summary.log" | head -1)
              if [ -f "$ADV_SUMMARY_FILE" ]; then
                echo "â”Œâ”€ BACKEND DIAGNOSTICS (ADVANCED) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
                cat "$ADV_SUMMARY_FILE"
                echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
                echo ""
              fi
            fi

            # API profiling summary
            if [ -f /tmp/comprehensive-api-profiler-${{ github.run_number }}/SUMMARY.txt ]; then
              echo "â”Œâ”€ API PROFILING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
              cat /tmp/comprehensive-api-profiler-${{ github.run_number }}/SUMMARY.txt
              echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
              echo ""
            fi

            # Resource monitoring summary
            if [ -d ./diagnostics-resources ]; then
              RESOURCE_SUMMARY=$(find ./diagnostics-resources -name "SUMMARY.txt" -type f | head -1)
              if [ -f "$RESOURCE_SUMMARY" ]; then
                echo "â”Œâ”€ RESOURCE MONITORING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
                cat "$RESOURCE_SUMMARY"
                echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
                echo ""
              fi
            fi

            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "ARTIFACTS AVAILABLE"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "All diagnostic data is available in GitHub Actions artifacts:"
            echo ""

            if [ "${{ github.event.inputs.run_browser_diagnostics }}" = "true" ]; then
              echo "ğŸ“¦ browser-diagnostics-${{ github.run_number }}"
              echo "   â€¢ Console errors and warnings"
              echo "   â€¢ Network request logs with timings"
              echo "   â€¢ Performance metrics and FPS data"
              echo "   â€¢ DOM complexity analysis"
              echo "   â€¢ Screenshots of page states"
              echo "   â€¢ JavaScript error traces"
              echo ""
            fi

            if [ "${{ github.event.inputs.run_backend_diagnostics }}" = "true" ]; then
              echo "ğŸ“¦ backend-diagnostics-basic-${{ github.run_number }}"
              echo "   â€¢ plugins.json validation results"
              echo "   â€¢ Plugin directory checks"
              echo "   â€¢ Permission analysis"
              echo "   â€¢ Auto-fix logs (if mode=fix)"
              echo "   â€¢ Manual action recommendations"
              echo ""

              if [ "${{ github.event.inputs.run_advanced_backend }}" = "true" ]; then
                echo "ğŸ“¦ backend-diagnostics-advanced-${{ github.run_number }}"
                echo "   â€¢ Deep plugin structure analysis"
                echo "   â€¢ Dependency validation"
                echo "   â€¢ Configuration file checks"
                echo "   â€¢ Advanced troubleshooting data"
                echo ""
              fi
            fi

            if [ "${{ github.event.inputs.run_api_profiling }}" = "true" ]; then
              echo "ğŸ“¦ api-profiling-${{ github.run_number }}"
              echo "   â€¢ API response times for all endpoints"
              echo "   â€¢ Request/response samples"
              echo "   â€¢ Error case testing results"
              echo "   â€¢ Performance bottleneck analysis"
              echo ""
            fi

            if [ "${{ github.event.inputs.run_resource_monitoring }}" = "true" ]; then
              echo "ğŸ“¦ resource-monitoring-${{ github.run_number }}"
              echo "   â€¢ System CPU/memory usage over time"
              echo "   â€¢ Docker container statistics"
              echo "   â€¢ Network connection tracking"
              echo "   â€¢ Process resource usage"
              echo ""
            fi

            echo "ğŸ“¦ comprehensive-summary-${{ github.run_number }}"
            echo "   â€¢ This master summary report"
            echo "   â€¢ Debugging recommendations"
            echo "   â€¢ Quick reference guide"
            echo ""

            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "RAPID TRIAGE & DEBUGGING GUIDE"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "ğŸ” Start debugging by following this priority order:"
            echo ""
            echo "1. FRONTEND ISSUES (Browser Freezes, UI Not Loading)"
            echo "   â†’ Check: browser-diagnostics/SUMMARY.txt"
            echo "   â†’ Look for: JavaScript errors, failed network requests"
            echo "   â†’ Review: screenshots/ to see visual state"
            echo "   â†’ Examine: console-errors.json for error details"
            echo ""
            echo "2. BACKEND ISSUES (Plugin Manager Not Working)"
            echo "   â†’ Check: backend-diagnostics-basic/summary.log"
            echo "   â†’ Look for: Permission errors, missing files"
            echo "   â†’ Review: issues.log for detected problems"
            echo "   â†’ Check: fixes.log to see what was auto-fixed"
            echo ""
            echo "3. API ISSUES (Slow Response, Errors)"
            echo "   â†’ Check: api-profiling/SUMMARY.txt"
            echo "   â†’ Look for: Slow endpoints (>1000ms)"
            echo "   â†’ Review: *-timing.txt files for bottlenecks"
            echo "   â†’ Examine: *-response.json for error messages"
            echo ""
            echo "4. RESOURCE ISSUES (High CPU/Memory, Container Problems)"
            echo "   â†’ Check: resource-monitoring/SUMMARY.txt"
            echo "   â†’ Look for: CPU >80%, Memory >90%"
            echo "   â†’ Review: system-resources.log for trends"
            echo "   â†’ Check: container-stats.log for Docker issues"
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "COMMON PROBLEM PATTERNS"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "âš ï¸  Page loads but plugins don't appear:"
            echo "   â€¢ Check browser-diagnostics for API call failures"
            echo "   â€¢ Verify CSRF token in network-requests.json"
            echo "   â€¢ Check backend permissions for plugins.json"
            echo ""
            echo "âš ï¸  High CPU during page load:"
            echo "   â€¢ Review resource-monitoring for spike timing"
            echo "   â€¢ Check browser-diagnostics performance-metrics.json"
            echo "   â€¢ Look for DOM complexity in dom-analysis.json"
            echo ""
            echo "âš ï¸  Plugin install fails:"
            echo "   â€¢ Check backend-diagnostics for write permissions"
            echo "   â€¢ Review api-profiling for /api/plugins/install errors"
            echo "   â€¢ Verify Docker container has disk space"
            echo ""
            echo "âš ï¸  Session/authentication issues:"
            echo "   â€¢ Check api-profiling for 401/403 responses"
            echo "   â€¢ Review browser-diagnostics for cookie problems"
            echo "   â€¢ Check backend logs in backend-diagnostics"
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "NEXT STEPS FOR DEBUGGING"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "1. Download all artifacts from this workflow run"
            echo "2. Start with this MASTER-SUMMARY.txt file"
            echo "3. Follow the Rapid Triage Guide above based on symptoms"
            echo "4. Review relevant artifact sections in priority order"
            echo "5. Cross-reference findings between different diagnostic types"
            echo "6. Use timestamps to correlate events across artifacts"
            echo ""
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "SECRETS CONFIGURATION STATUS"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "This workflow uses GitHub repository secrets to access remote"
            echo "resources and credentials. Some diagnostics require specific"
            echo "secrets to be configured."
            echo ""
            echo "â”Œâ”€ SECRETS STATUS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
            echo ""

            # Server access secrets
            if [ "${{ steps.secrets_check.outputs.has_server_host }}" = "true" ]; then
              echo "  âœ… SERVER_HOST          : Configured"
            else
              echo "  âŒ SERVER_HOST          : NOT configured"
            fi

            if [ "${{ steps.secrets_check.outputs.has_server_user }}" = "true" ]; then
              echo "  âœ… SERVER_USER          : Configured"
            else
              echo "  âŒ SERVER_USER          : NOT configured"
            fi

            if [ "${{ steps.secrets_check.outputs.has_ssh_key }}" = "true" ]; then
              echo "  âœ… SSH_PRIVATE_KEY      : Configured"
            else
              echo "  âŒ SSH_PRIVATE_KEY      : NOT configured"
            fi

            # Console credentials
            if [ "${{ steps.secrets_check.outputs.has_console_user }}" = "true" ]; then
              echo "  âœ… CONSOLE_ADMIN_USER   : Configured"
            else
              echo "  âš ï¸  CONSOLE_ADMIN_USER   : Using default (admin)"
            fi

            if [ "${{ steps.secrets_check.outputs.has_console_pass }}" = "true" ]; then
              echo "  âœ… CONSOLE_ADMIN_PASSWORD: Configured"
            else
              echo "  âš ï¸  CONSOLE_ADMIN_PASSWORD: Using default (admin)"
            fi

            echo ""
            echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
            echo ""

            # Explain what was skipped
            echo "â”Œâ”€ DIAGNOSTICS EXECUTED/SKIPPED BASED ON SECRETS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
            echo ""

            if [ "${{ steps.secrets_check.outputs.can_ssh }}" = "true" ]; then
              echo "  âœ… Remote SSH Access: ENABLED"
              echo "     â”œâ”€ Backend diagnostics: Available"
              echo "     â”œâ”€ Resource monitoring: Available"
              echo "     â””â”€ Server file access: Available"
            else
              echo "  âŒ Remote SSH Access: DISABLED"
              echo "     Missing: SERVER_HOST, SERVER_USER, or SSH_PRIVATE_KEY"
              echo "     â”œâ”€ Backend diagnostics: SKIPPED"
              echo "     â”œâ”€ Resource monitoring: SKIPPED"
              echo "     â””â”€ Server file access: UNAVAILABLE"
            fi

            echo ""

            if [ "${{ github.event.inputs.run_browser_diagnostics }}" = "true" ]; then
              echo "  âœ… Browser Diagnostics: EXECUTED"
              echo "     Uses: CONSOLE_ADMIN_USER, CONSOLE_ADMIN_PASSWORD"
              echo "     Note: Defaults used if secrets not configured"
            fi

            if [ "${{ github.event.inputs.run_api_profiling }}" = "true" ]; then
              echo "  âœ… API Profiling: EXECUTED"
              echo "     Uses: CONSOLE_ADMIN_USER, CONSOLE_ADMIN_PASSWORD"
              echo "     Note: Defaults used if secrets not configured"
            fi

            echo ""
            echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
            echo ""

            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "HOW TO ADD MISSING SECRETS"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "To enable full diagnostic capabilities, configure these secrets"
            echo "in your GitHub repository:"
            echo ""
            echo "1. Navigate to: Repository â†’ Settings â†’ Secrets and variables â†’ Actions"
            echo ""
            echo "2. Click 'New repository secret' for each missing secret:"
            echo ""
            echo "   SECRET NAME              DESCRIPTION                      REQUIRED FOR"
            echo "   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            echo "   SERVER_HOST              Production server hostname       Remote diagnostics"
            echo "                            (e.g., server.example.com)"
            echo ""
            echo "   SERVER_USER              SSH username for server          Remote diagnostics"
            echo "                            (e.g., deploy, ubuntu)"
            echo ""
            echo "   SSH_PRIVATE_KEY          SSH private key for auth         Remote diagnostics"
            echo "                            (full key including headers)"
            echo ""
            echo "   CONSOLE_ADMIN_USER       Console admin username           Browser/API testing"
            echo "                            (default: admin)"
            echo ""
            echo "   CONSOLE_ADMIN_PASSWORD   Console admin password           Browser/API testing"
            echo "                            (default: admin)"
            echo ""
            echo "3. SECURITY BEST PRACTICES:"
            echo ""
            echo "   â€¢ Never commit secrets to code"
            echo "   â€¢ Use dedicated SSH keys for CI/CD (not personal keys)"
            echo "   â€¢ Rotate secrets regularly"
            echo "   â€¢ Grant minimum required permissions"
            echo "   â€¢ Use strong, unique passwords"
            echo "   â€¢ Limit secret access to necessary workflows only"
            echo ""
            echo "4. SSH KEY GENERATION:"
            echo ""
            echo "   # Generate a dedicated key pair for GitHub Actions"
            echo "   ssh-keygen -t ed25519 -C 'github-actions' -f github_actions_key"
            echo ""
            echo "   # Add public key to server's authorized_keys"
            echo "   ssh-copy-id -i github_actions_key.pub user@server.example.com"
            echo ""
            echo "   # Add private key content to SSH_PRIVATE_KEY secret"
            echo "   cat github_actions_key  # Copy entire output including headers"
            echo ""
            echo "5. TESTING YOUR CONFIGURATION:"
            echo ""
            echo "   After adding secrets, run this workflow again to verify:"
            echo "   â€¢ All secret detection checks show âœ…"
            echo "   â€¢ Remote diagnostics are no longer skipped"
            echo "   â€¢ All enabled components execute successfully"
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "WORKFLOW DISPATCH INFORMATION"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "This workflow is FULLY SELF-DISPATCHABLE from GitHub Actions UI."
            echo ""
            echo "âœ… NO manual file changes required"
            echo "âœ… NO secrets needed in workflow YAML conditions"
            echo "âœ… Graceful fallback for missing secrets"
            echo "âœ… Clear explanations for skipped steps"
            echo ""
            echo "To run again:"
            echo "  1. Go to: Actions â†’ Comprehensive Plugin Manager Diagnostics"
            echo "  2. Click: 'Run workflow' button"
            echo "  3. Configure: Options or use defaults"
            echo "  4. Click: 'Run workflow' (green button)"
            echo ""
            echo "The workflow will automatically:"
            echo "  â€¢ Detect available secrets at runtime"
            echo "  â€¢ Skip unavailable diagnostics gracefully"
            echo "  â€¢ Explain what was run and what was skipped"
            echo "  â€¢ Provide guidance for enabling full diagnostics"
            echo ""
            echo "For detailed documentation, see:"
            echo "  â€¢ docs/DIAGNOSTICS-GUIDE.md"
            echo "  â€¢ docs/BROWSER-DIAGNOSTICS.md"
            echo "  â€¢ docs/PLUGIN-INSTALL-DIAGNOSTICS.md"
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "END OF MASTER SUMMARY"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          } > ./comprehensive-summary/MASTER-SUMMARY.txt

          # Also create a markdown version for GitHub display
          {
            echo "# Comprehensive Plugin Manager Diagnostics"
            echo ""
            echo "**Generated:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo ""
            echo "**Workflow Run:** #${{ github.run_number }}"
            echo ""
            echo "**Console URL:** ${{ steps.console_url.outputs.url }}"
            echo ""
            echo "## Components Executed"
            echo ""

            if [ "${{ github.event.inputs.run_browser_diagnostics }}" = "true" ]; then
              echo "- âœ… Browser Automation Diagnostics"
            else
              echo "- â­ï¸ Browser Automation Diagnostics (skipped)"
            fi

            if [ "${{ github.event.inputs.run_backend_diagnostics }}" = "true" ]; then
              echo "- âœ… Backend/Plugin Diagnostics (mode: ${{ github.event.inputs.backend_mode }})"
            else
              echo "- â­ï¸ Backend/Plugin Diagnostics (skipped)"
            fi

            if [ "${{ github.event.inputs.run_api_profiling }}" = "true" ]; then
              echo "- âœ… API Endpoint Profiling"
            else
              echo "- â­ï¸ API Endpoint Profiling (skipped)"
            fi

            if [ "${{ github.event.inputs.run_resource_monitoring }}" = "true" ]; then
              echo "- âœ… Resource Monitoring"
            else
              echo "- â­ï¸ Resource Monitoring (skipped)"
            fi

            echo ""
            echo "## Quick Links to Artifacts"
            echo ""
            echo "Download the following artifacts from this workflow run for detailed diagnostics:"
            echo ""

            [ "${{ github.event.inputs.run_browser_diagnostics }}" = "true" ] && \
              echo "- ğŸ“¦ \`browser-diagnostics-${{ github.run_number }}\` - Browser automation results"

            [ "${{ github.event.inputs.run_backend_diagnostics }}" = "true" ] && \
              echo "- ğŸ“¦ \`backend-diagnostics-basic-${{ github.run_number }}\` - Plugin manager diagnostics"

            [ "${{ github.event.inputs.run_backend_diagnostics }}" = "true" ] && \
              [ "${{ github.event.inputs.run_advanced_backend }}" = "true" ] && \
              echo "- ğŸ“¦ \`backend-diagnostics-advanced-${{ github.run_number }}\` - Advanced diagnostics"

            [ "${{ github.event.inputs.run_api_profiling }}" = "true" ] && \
              echo "- ğŸ“¦ \`api-profiling-${{ github.run_number }}\` - API performance data"

            [ "${{ github.event.inputs.run_resource_monitoring }}" = "true" ] && \
              echo "- ğŸ“¦ \`resource-monitoring-${{ github.run_number }}\` - Resource usage data"

            echo "- ğŸ“¦ \`comprehensive-summary-${{ github.run_number }}\` - Master summary (this report)"
            echo ""
            echo "## Debugging Priority"
            echo ""
            echo "See the MASTER-SUMMARY.txt file in the comprehensive-summary artifact for:"
            echo ""
            echo "- ğŸ” Rapid triage guide"
            echo "- âš ï¸ Common problem patterns"
            echo "- ğŸ“‹ Step-by-step debugging workflow"
            echo "- ğŸ”— Cross-references between artifacts"
            echo ""

          } > ./comprehensive-summary/README.md

          # Create a dedicated secrets configuration guide
          {
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "SECRETS CONFIGURATION GUIDE"
            echo "Comprehensive Plugin Manager Diagnostics Workflow"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "This guide explains how to configure GitHub repository secrets"
            echo "to enable full diagnostic capabilities in this workflow."
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "CURRENT SECRET STATUS"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""

            if [ "${{ steps.secrets_check.outputs.has_server_host }}" = "true" ]; then
              echo "âœ… SERVER_HOST          : Configured"
            else
              echo "âŒ SERVER_HOST          : NOT configured"
            fi

            if [ "${{ steps.secrets_check.outputs.has_server_user }}" = "true" ]; then
              echo "âœ… SERVER_USER          : Configured"
            else
              echo "âŒ SERVER_USER          : NOT configured"
            fi

            if [ "${{ steps.secrets_check.outputs.has_ssh_key }}" = "true" ]; then
              echo "âœ… SSH_PRIVATE_KEY      : Configured"
            else
              echo "âŒ SSH_PRIVATE_KEY      : NOT configured"
            fi

            if [ "${{ steps.secrets_check.outputs.has_console_user }}" = "true" ]; then
              echo "âœ… CONSOLE_ADMIN_USER   : Configured"
            else
              echo "âš ï¸  CONSOLE_ADMIN_USER   : Using default (admin)"
            fi

            if [ "${{ steps.secrets_check.outputs.has_console_pass }}" = "true" ]; then
              echo "âœ… CONSOLE_ADMIN_PASSWORD: Configured"
            else
              echo "âš ï¸  CONSOLE_ADMIN_PASSWORD: Using default (admin)"
            fi

            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "REQUIRED SECRETS BY DIAGNOSTIC TYPE"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "â”Œâ”€ BROWSER DIAGNOSTICS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
            echo "â”‚ â€¢ CONSOLE_ADMIN_USER      (optional - defaults to 'admin')    â”‚"
            echo "â”‚ â€¢ CONSOLE_ADMIN_PASSWORD  (optional - defaults to 'admin')    â”‚"
            echo "â”‚                                                                â”‚"
            echo "â”‚ What it enables:                                              â”‚"
            echo "â”‚   - Automated browser login                                   â”‚"
            echo "â”‚   - Page interaction testing                                  â”‚"
            echo "â”‚   - Screenshot capture of authenticated pages                 â”‚"
            echo "â”‚   - Network request monitoring                                â”‚"
            echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
            echo ""
            echo "â”Œâ”€ API PROFILING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
            echo "â”‚ â€¢ CONSOLE_ADMIN_USER      (optional - defaults to 'admin')    â”‚"
            echo "â”‚ â€¢ CONSOLE_ADMIN_PASSWORD  (optional - defaults to 'admin')    â”‚"
            echo "â”‚                                                                â”‚"
            echo "â”‚ What it enables:                                              â”‚"
            echo "â”‚   - API endpoint authentication testing                       â”‚"
            echo "â”‚   - CSRF token flow validation                                â”‚"
            echo "â”‚   - Session management testing                                â”‚"
            echo "â”‚   - Performance profiling of protected endpoints             â”‚"
            echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
            echo ""
            echo "â”Œâ”€ BACKEND DIAGNOSTICS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
            echo "â”‚ â€¢ SERVER_HOST             (REQUIRED for remote diagnostics)   â”‚"
            echo "â”‚ â€¢ SERVER_USER             (REQUIRED for remote diagnostics)   â”‚"
            echo "â”‚ â€¢ SSH_PRIVATE_KEY         (REQUIRED for remote diagnostics)   â”‚"
            echo "â”‚                                                                â”‚"
            echo "â”‚ What it enables:                                              â”‚"
            echo "â”‚   - Remote server file access                                 â”‚"
            echo "â”‚   - Plugin manager diagnostics                                â”‚"
            echo "â”‚   - Permission and ownership checks                           â”‚"
            echo "â”‚   - Auto-fix capabilities (in fix mode)                       â”‚"
            echo "â”‚   - Advanced plugin structure analysis                        â”‚"
            echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
            echo ""
            echo "â”Œâ”€ RESOURCE MONITORING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
            echo "â”‚ â€¢ SERVER_HOST             (REQUIRED for remote monitoring)    â”‚"
            echo "â”‚ â€¢ SERVER_USER             (REQUIRED for remote monitoring)    â”‚"
            echo "â”‚ â€¢ SSH_PRIVATE_KEY         (REQUIRED for remote monitoring)    â”‚"
            echo "â”‚                                                                â”‚"
            echo "â”‚ What it enables:                                              â”‚"
            echo "â”‚   - CPU and memory usage tracking                             â”‚"
            echo "â”‚   - Docker container statistics                               â”‚"
            echo "â”‚   - Network connection monitoring                             â”‚"
            echo "â”‚   - Process resource analysis                                 â”‚"
            echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "HOW TO ADD SECRETS"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "STEP 1: Navigate to Secrets Settings"
            echo "--------------------------------------"
            echo "1. Go to your GitHub repository"
            echo "2. Click 'Settings' tab"
            echo "3. In left sidebar: 'Secrets and variables' â†’ 'Actions'"
            echo "4. Click 'New repository secret' button"
            echo ""
            echo "STEP 2: Add Each Required Secret"
            echo "----------------------------------"
            echo ""
            echo "SECRET: SERVER_HOST"
            echo "  Description: Hostname or IP address of your production server"
            echo "  Example: server.example.com  OR  203.0.113.42"
            echo "  How to get: Check your server provider dashboard"
            echo ""
            echo "SECRET: SERVER_USER"
            echo "  Description: SSH username for server access"
            echo "  Example: deploy, ubuntu, admin, root"
            echo "  How to get: Check server account settings or hosting docs"
            echo ""
            echo "SECRET: SSH_PRIVATE_KEY"
            echo "  Description: Private SSH key for authentication"
            echo "  Format: Full key including BEGIN/END headers"
            echo "  Example:"
            echo "    -----BEGIN OPENSSH PRIVATE KEY-----"
            echo "    b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAA..."
            echo "    -----END OPENSSH PRIVATE KEY-----"
            echo ""
            echo "  How to generate (RECOMMENDED - dedicated key for CI/CD):"
            echo "    1. On your local machine:"
            echo "       ssh-keygen -t ed25519 -C 'github-actions-diagnostics' -f ~/.ssh/github_actions"
            echo ""
            echo "    2. Add public key to server:"
            echo "       ssh-copy-id -i ~/.ssh/github_actions.pub user@server.example.com"
            echo "       # OR manually append to server's ~/.ssh/authorized_keys"
            echo ""
            echo "    3. Copy private key content:"
            echo "       cat ~/.ssh/github_actions"
            echo "       # Copy ENTIRE output including headers"
            echo ""
            echo "    4. Paste into SSH_PRIVATE_KEY secret"
            echo ""
            echo "SECRET: CONSOLE_ADMIN_USER"
            echo "  Description: Username for console web interface"
            echo "  Default: admin (used if not configured)"
            echo "  Example: admin, superuser, administrator"
            echo ""
            echo "SECRET: CONSOLE_ADMIN_PASSWORD"
            echo "  Description: Password for console web interface"
            echo "  Default: admin (used if not configured - INSECURE!)"
            echo "  Recommendation: Use strong, unique password"
            echo "  Example: Generate with: openssl rand -base64 32"
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "SECURITY BEST PRACTICES"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "âœ… DO:"
            echo "  â€¢ Use dedicated SSH keys for CI/CD (not your personal key)"
            echo "  â€¢ Use ed25519 keys (modern, secure, fast)"
            echo "  â€¢ Rotate secrets regularly (every 90-180 days)"
            echo "  â€¢ Use strong, unique passwords (min 16 characters)"
            echo "  â€¢ Limit SSH key permissions on server (read-only if possible)"
            echo "  â€¢ Monitor secret usage in workflow logs"
            echo "  â€¢ Use environment-specific secrets (staging vs production)"
            echo ""
            echo "âŒ DON'T:"
            echo "  â€¢ Commit secrets to code or documentation"
            echo "  â€¢ Share secrets between different environments"
            echo "  â€¢ Use root account for CI/CD access"
            echo "  â€¢ Reuse personal SSH keys"
            echo "  â€¢ Use weak/default passwords in production"
            echo "  â€¢ Store secrets in workflow files"
            echo "  â€¢ Echo or print secret values in logs"
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "SSH KEY SECURITY"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "When generating SSH keys for GitHub Actions:"
            echo ""
            echo "1. Use a dedicated key pair (don't reuse personal keys)"
            echo "2. Add to authorized_keys with restrictions:"
            echo "   from=\"140.82.112.0/20,143.55.64.0/20\" ssh-ed25519 AAAA..."
            echo "   (GitHub Actions IP ranges)"
            echo ""
            echo "3. Consider command restrictions in authorized_keys:"
            echo "   command=\"/path/to/allowed-commands.sh\" ssh-ed25519 AAAA..."
            echo ""
            echo "4. Monitor SSH access logs:"
            echo "   tail -f /var/log/auth.log  # Debian/Ubuntu"
            echo "   tail -f /var/log/secure    # RHEL/CentOS"
            echo ""
            echo "5. Revoke key if compromised:"
            echo "   Remove from ~/.ssh/authorized_keys on server"
            echo "   Delete from GitHub repository secrets"
            echo "   Generate and configure new key pair"
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "TESTING YOUR CONFIGURATION"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "After adding secrets, verify they work:"
            echo ""
            echo "1. Run this workflow again from GitHub Actions"
            echo "2. Check the 'Detect and document available secrets' step"
            echo "3. Verify all required secrets show âœ…"
            echo "4. Confirm no diagnostics are skipped (unless intentional)"
            echo "5. Review artifacts to ensure data was collected"
            echo ""
            echo "Common issues and fixes:"
            echo ""
            echo "âŒ \"Permission denied (publickey)\""
            echo "   â†’ Public key not in authorized_keys on server"
            echo "   â†’ Wrong username in SERVER_USER"
            echo "   â†’ Key format issue (check for extra whitespace)"
            echo ""
            echo "âŒ \"Host key verification failed\""
            echo "   â†’ Workflow includes ssh-keyscan step to handle this"
            echo "   â†’ Check SERVER_HOST is correct"
            echo ""
            echo "âŒ \"Login failed\" in browser/API tests"
            echo "   â†’ Check CONSOLE_ADMIN_USER and CONSOLE_ADMIN_PASSWORD"
            echo "   â†’ Verify credentials work manually first"
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "MINIMAL SETUP FOR TESTING"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "If you want to test the workflow without remote server access:"
            echo ""
            echo "1. Configure only CONSOLE_ADMIN_USER and CONSOLE_ADMIN_PASSWORD"
            echo "2. Enable only:"
            echo "   - Browser diagnostics"
            echo "   - API profiling"
            echo "3. Skip:"
            echo "   - Backend diagnostics (requires SSH)"
            echo "   - Resource monitoring (requires SSH)"
            echo ""
            echo "This will run local diagnostics against the console URL without"
            echo "requiring server access."
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "FULL SETUP FOR PRODUCTION"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "For complete diagnostic capabilities:"
            echo ""
            echo "1. Configure all 5 secrets:"
            echo "   âœ… SERVER_HOST"
            echo "   âœ… SERVER_USER"
            echo "   âœ… SSH_PRIVATE_KEY"
            echo "   âœ… CONSOLE_ADMIN_USER"
            echo "   âœ… CONSOLE_ADMIN_PASSWORD"
            echo ""
            echo "2. Enable all diagnostic components in workflow inputs"
            echo ""
            echo "3. Run with default settings for comprehensive analysis"
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "SUPPORT AND TROUBLESHOOTING"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "If you encounter issues:"
            echo ""
            echo "1. Check workflow logs for detailed error messages"
            echo "2. Review MASTER-SUMMARY.txt for what was executed/skipped"
            echo "3. Verify secrets are configured correctly in GitHub"
            echo "4. Test SSH connection manually: ssh -i key user@host"
            echo "5. Check server firewall allows SSH from GitHub Actions IPs"
            echo "6. Review server logs: /var/log/auth.log or /var/log/secure"
            echo ""
            echo "For more help:"
            echo "  â€¢ Repository: docs/DIAGNOSTICS-GUIDE.md"
            echo "  â€¢ Workflow file: .github/workflows/comprehensive-plugin-manager-diagnostics.yml"
            echo "  â€¢ GitHub Actions: https://docs.github.com/en/actions/security-guides/encrypted-secrets"
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "END OF SECRETS CONFIGURATION GUIDE"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          } > ./comprehensive-summary/SECRETS-GUIDE.txt

          echo "âœ“ Master summary generated"
          cat ./comprehensive-summary/MASTER-SUMMARY.txt

      # ========================================================================
      # UPLOAD ARTIFACTS
      # ========================================================================
      - name: Upload browser diagnostics artifact
        uses: actions/upload-artifact@v4
        if: always() && github.event.inputs.run_browser_diagnostics == 'true'
        with:
          name: browser-diagnostics-${{ github.run_number }}
          path: /tmp/comprehensive-browser-diagnostics-${{ github.run_number }}/
          retention-days: 30
          if-no-files-found: warn

      - name: Upload backend basic diagnostics artifact
        uses: actions/upload-artifact@v4
        if: always() && github.event.inputs.run_backend_diagnostics == 'true'
        with:
          name: backend-diagnostics-basic-${{ github.run_number }}
          path: diagnostics-backend-basic/
          retention-days: 30
          if-no-files-found: warn

      - name: Upload backend advanced diagnostics artifact
        uses: actions/upload-artifact@v4
        if: always() && github.event.inputs.run_backend_diagnostics == 'true' && github.event.inputs.run_advanced_backend == 'true'
        with:
          name: backend-diagnostics-advanced-${{ github.run_number }}
          path: diagnostics-backend-advanced/
          retention-days: 30
          if-no-files-found: warn

      - name: Upload API profiling artifact
        uses: actions/upload-artifact@v4
        if: always() && github.event.inputs.run_api_profiling == 'true'
        with:
          name: api-profiling-${{ github.run_number }}
          path: /tmp/comprehensive-api-profiler-${{ github.run_number }}/
          retention-days: 30
          if-no-files-found: warn

      - name: Upload resource monitoring artifact
        uses: actions/upload-artifact@v4
        if: always() && github.event.inputs.run_resource_monitoring == 'true'
        with:
          name: resource-monitoring-${{ github.run_number }}
          path: ./diagnostics-resources/
          retention-days: 30
          if-no-files-found: warn

      - name: Upload comprehensive summary artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: comprehensive-summary-${{ github.run_number }}
          path: ./comprehensive-summary/
          retention-days: 30
          if-no-files-found: warn

      # ========================================================================
      # DISPLAY SUMMARY IN WORKFLOW
      # ========================================================================
      - name: Display summary in workflow
        if: always()
        run: |
          if [ -f ./comprehensive-summary/README.md ]; then
            cat ./comprehensive-summary/README.md >> $GITHUB_STEP_SUMMARY
          fi

      # ========================================================================
      # CLEANUP
      # ========================================================================
      - name: Cleanup server files
        if: always() && steps.secrets_check.outputs.can_ssh == 'true'
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                    CLEANUP                                     â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

          ssh -i ~/.ssh/id_rsa ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF' || true
            # Remove temporary files from this run
            rm -f /tmp/resource-monitor-${{ github.run_number }}.pid
            rm -f /tmp/resource-monitor-${{ github.run_number }}.log
            rm -f /tmp/comprehensive-diagnostics-resources-${{ github.run_number }}.tar.gz
            rm -rf /tmp/comprehensive-diagnostics-resources-${{ github.run_number }}
            rm -f /tmp/plugin-diagnostics-basic-${{ github.run_number }}.tar.gz
            rm -f /tmp/plugin-diagnostics-advanced-${{ github.run_number }}.tar.gz

            # Keep diagnostic directories for 7 days, clean up older ones
            find /tmp -maxdepth 1 -name "plugin-diagnostics-*" -type d -mtime +7 -exec rm -rf {} \; 2>/dev/null || true
            find /tmp -maxdepth 1 -name "comprehensive-diagnostics-resources-*" -type d -mtime +7 -exec rm -rf {} \; 2>/dev/null || true

            echo "âœ“ Cleanup complete"
          EOF
