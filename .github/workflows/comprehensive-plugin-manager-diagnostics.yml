# Comprehensive Plugin Manager Diagnostics Workflow (v2.0)
#
# This workflow combines all diagnostic tools into a single coordinated run:
# - Browser diagnostics (Puppeteer automation)
# - Backend/plugin diagnostics (plugin manager checks)
# - API profiling (endpoint performance testing)
# - Resource monitoring (CPU, memory, Docker stats)
# - Secrets requirements documentation
#
# ✅ FULLY SELF-DISPATCHABLE - Run from GitHub Actions UI without any manual changes!
# ✅ NO SECRET-DEPENDENT IF CONDITIONS - Uses runtime detection instead
# ✅ GRACEFUL FALLBACK - Missing secrets skip steps with clear explanations
# ✅ COMPREHENSIVE REPORTING - Includes secrets usage and requirements documentation
#
# WHEN TO USE:
# - Complex issues where root cause is unclear
# - Production health checks / post-deployment validation
# - Performance issues
# - Complete system diagnostics
#
# WHAT YOU GET:
# - Master summary with rapid triage guide
# - Individual artifacts for each diagnostic type
# - Cross-referenced findings
# - Actionable debugging recommendations
# - Secrets requirements and usage documentation
# - Step-by-step guide for enabling full diagnostics
#
# HOW TO USE:
# 1. Go to Actions → Comprehensive Plugin Manager Diagnostics
# 2. Click "Run workflow"
# 3. Configure options (or use defaults)
# 4. Review artifacts starting with comprehensive-summary
#
# See docs/DIAGNOSTICS-GUIDE.md for detailed documentation

name: Comprehensive Plugin Manager Diagnostics

on:
  workflow_dispatch:
    inputs:
      console_url:
        description: 'Console URL to test (defaults to deployed console)'
        required: false
        type: string

      # Feature toggles
      run_browser_diagnostics:
        description: 'Run browser-based diagnostics (Puppeteer)'
        required: true
        type: boolean
        default: true

      run_backend_diagnostics:
        description: 'Run backend/plugin diagnostics'
        required: true
        type: boolean
        default: true

      run_api_profiling:
        description: 'Run API endpoint profiling'
        required: true
        type: boolean
        default: true

      run_resource_monitoring:
        description: 'Run resource monitoring (CPU, memory, Docker)'
        required: true
        type: boolean
        default: true

      # Backend diagnostics options
      backend_mode:
        description: 'Backend diagnostic mode (diagnose or fix)'
        required: true
        type: choice
        options:
          - diagnose
          - fix
        default: diagnose

      run_advanced_backend:
        description: 'Run advanced backend diagnostics'
        required: true
        type: boolean
        default: true

      # Browser options
      headless:
        description: 'Run browser in headless mode'
        required: true
        type: boolean
        default: true

      # Resource monitoring options
      monitor_duration:
        description: 'Resource monitoring duration (seconds)'
        required: true
        type: number
        default: 90

      monitor_interval:
        description: 'Resource monitoring sample interval (seconds)'
        required: true
        type: number
        default: 2

jobs:
  comprehensive-diagnostics:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      actions: write

    env:
      DEPLOY_DIR: /home/deploy/minecraft-server
      CONSOLE_DIR: /home/deploy/minecraft-console
      RUN_NUMBER: ${{ github.run_number }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Detect and document available secrets
        id: secrets_check
        env:
          CHECK_SERVER_HOST: ${{ secrets.SERVER_HOST }}
          CHECK_SERVER_USER: ${{ secrets.SERVER_USER }}
          CHECK_SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          CHECK_CONSOLE_USER: ${{ secrets.CONSOLE_ADMIN_USER }}
          CHECK_CONSOLE_PASS: ${{ secrets.CONSOLE_ADMIN_PASSWORD }}
        run: |
          echo "╔════════════════════════════════════════════════════════════════╗"
          echo "║           DETECTING AVAILABLE SECRETS                          ║"
          echo "╚════════════════════════════════════════════════════════════════╝"
          echo ""

          # Check each secret and set flags
          # Use environment variables instead of direct secret access for safety

          HAS_SERVER_HOST="false"
          HAS_SERVER_USER="false"
          HAS_SSH_KEY="false"
          HAS_CONSOLE_USER="false"
          HAS_CONSOLE_PASS="false"

          # Check SERVER_HOST
          if [ -n "$CHECK_SERVER_HOST" ]; then
            echo "✓ SERVER_HOST is configured"
            HAS_SERVER_HOST="true"
          else
            echo "✗ SERVER_HOST is NOT configured"
          fi

          # Check SERVER_USER
          if [ -n "$CHECK_SERVER_USER" ]; then
            echo "✓ SERVER_USER is configured"
            HAS_SERVER_USER="true"
          else
            echo "✗ SERVER_USER is NOT configured"
          fi

          # Check SSH_PRIVATE_KEY
          if [ -n "$CHECK_SSH_KEY" ]; then
            echo "✓ SSH_PRIVATE_KEY is configured"
            HAS_SSH_KEY="true"
          else
            echo "✗ SSH_PRIVATE_KEY is NOT configured"
          fi

          # Check CONSOLE_ADMIN_USER
          if [ -n "$CHECK_CONSOLE_USER" ]; then
            echo "✓ CONSOLE_ADMIN_USER is configured"
            HAS_CONSOLE_USER="true"
          else
            echo "✗ CONSOLE_ADMIN_USER is NOT configured (will use default: admin)"
          fi

          # Check CONSOLE_ADMIN_PASSWORD
          if [ -n "$CHECK_CONSOLE_PASS" ]; then
            echo "✓ CONSOLE_ADMIN_PASSWORD is configured"
            HAS_CONSOLE_PASS="true"
          else
            echo "✗ CONSOLE_ADMIN_PASSWORD is NOT configured (will use default: admin)"
          fi

          echo ""
          echo "Setting output flags for conditional steps..."
          echo "has_server_host=$HAS_SERVER_HOST" >> $GITHUB_OUTPUT
          echo "has_server_user=$HAS_SERVER_USER" >> $GITHUB_OUTPUT
          echo "has_ssh_key=$HAS_SSH_KEY" >> $GITHUB_OUTPUT
          echo "has_console_user=$HAS_CONSOLE_USER" >> $GITHUB_OUTPUT
          echo "has_console_pass=$HAS_CONSOLE_PASS" >> $GITHUB_OUTPUT

          # Determine if we can do remote diagnostics
          if [ "$HAS_SERVER_HOST" = "true" ] && [ "$HAS_SERVER_USER" = "true" ] && [ "$HAS_SSH_KEY" = "true" ]; then
            echo "can_ssh=true" >> $GITHUB_OUTPUT
            echo ""
            echo "✓ Remote diagnostics ENABLED (SSH access available)"
          else
            echo "can_ssh=false" >> $GITHUB_OUTPUT
            echo ""
            echo "✗ Remote diagnostics DISABLED (missing SSH credentials)"
            echo "  Required: SERVER_HOST, SERVER_USER, SSH_PRIVATE_KEY"
          fi

          echo ""
          echo "╔════════════════════════════════════════════════════════════════╗"
          echo "║           SECRET DETECTION COMPLETE                            ║"
          echo "╚════════════════════════════════════════════════════════════════╝"

      - name: Setup Node.js
        if: github.event.inputs.run_browser_diagnostics == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Puppeteer dependencies
        if: github.event.inputs.run_browser_diagnostics == 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libnss3 \
            libnspr4 \
            libatk1.0-0 \
            libatk-bridge2.0-0 \
            libcups2 \
            libdrm2 \
            libdbus-1-3 \
            libxkbcommon0 \
            libxcomposite1 \
            libxdamage1 \
            libxfixes3 \
            libxrandr2 \
            libgbm1 \
            libasound2 \
            libpango-1.0-0 \
            libcairo2

      - name: Install Puppeteer
        if: github.event.inputs.run_browser_diagnostics == 'true'
        run: |
          cd console/backend
          npm install puppeteer@21.6.1

      - name: Determine console URL
        id: console_url
        run: |
          if [ -n "${{ github.event.inputs.console_url }}" ]; then
            echo "url=${{ github.event.inputs.console_url }}" >> $GITHUB_OUTPUT
          else
            # Use deployed console URL (construct from secrets if available)
            if [ -n "${{ secrets.SERVER_HOST }}" ]; then
              echo "url=https://${{ secrets.SERVER_HOST }}/console" >> $GITHUB_OUTPUT
            else
              echo "url=http://localhost:3000" >> $GITHUB_OUTPUT
            fi
          fi

          echo "Console URL: $(grep url "$GITHUB_OUTPUT" | cut -d'=' -f2-)"

      - name: Setup SSH (if testing deployed console)
        if: steps.secrets_check.outputs.can_ssh == 'true'
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      # ========================================================================
      # RESOURCE MONITORING - Start monitoring early to capture all activity
      # ========================================================================
      - name: Start resource monitoring
        if: github.event.inputs.run_resource_monitoring == 'true' && steps.secrets_check.outputs.can_ssh == 'true'
        run: |
          echo "╔════════════════════════════════════════════════════════════════╗"
          echo "║               STARTING RESOURCE MONITORING                     ║"
          echo "╚════════════════════════════════════════════════════════════════╝"
          echo ""

          ssh -i ~/.ssh/id_rsa ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            # Configure resource monitor
            export OUTPUT_DIR=/tmp/comprehensive-diagnostics-resources-${{ github.run_number }}
            export MONITOR_DURATION=${{ github.event.inputs.monitor_duration }}
            export MONITOR_INTERVAL=${{ github.event.inputs.monitor_interval }}
            export CONTAINER_NAME=minecraft-console

            # Create scripts directory
            mkdir -p /tmp/scripts
          EOF

          # Upload resource monitor script
          scp -i ~/.ssh/id_rsa scripts/resource-monitor.sh \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/tmp/scripts/

          ssh -i ~/.ssh/id_rsa ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            chmod +x /tmp/scripts/resource-monitor.sh

            # Run in background
            nohup /tmp/scripts/resource-monitor.sh > /tmp/resource-monitor-${{ github.run_number }}.log 2>&1 &
            echo $! > /tmp/resource-monitor-${{ github.run_number }}.pid

            echo "✓ Resource monitoring started (PID: $(cat /tmp/resource-monitor-${{ github.run_number }}.pid))"
          EOF

      - name: Resource monitoring skipped (SSH not available)
        if: github.event.inputs.run_resource_monitoring == 'true' && steps.secrets_check.outputs.can_ssh != 'true'
        run: |
          echo "⚠️ Resource monitoring requires SSH access to remote server"
          echo "   Missing secrets: SERVER_HOST, SERVER_USER, and/or SSH_PRIVATE_KEY"
          echo "   This step has been skipped - see final summary for how to enable"

      # ========================================================================
      # BACKEND DIAGNOSTICS - Run plugin manager diagnostics
      # ========================================================================
      - name: Upload diagnostic scripts to server
        if: github.event.inputs.run_backend_diagnostics == 'true' && steps.secrets_check.outputs.can_ssh == 'true'
        run: |
          echo "╔════════════════════════════════════════════════════════════════╗"
          echo "║               BACKEND DIAGNOSTICS SETUP                        ║"
          echo "╚════════════════════════════════════════════════════════════════╝"
          echo ""

          echo "Uploading diagnostic scripts..."
          scp -i ~/.ssh/id_rsa \
            scripts/diagnose-plugins.sh \
            scripts/diagnose-plugins-advanced.sh \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ env.DEPLOY_DIR }}/scripts/

          echo "Setting executable permissions..."
          ssh -i ~/.ssh/id_rsa ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            chmod +x ${{ env.DEPLOY_DIR }}/scripts/diagnose-plugins.sh
            chmod +x ${{ env.DEPLOY_DIR }}/scripts/diagnose-plugins-advanced.sh
          EOF

          echo "✓ Diagnostic scripts uploaded"

      - name: Run basic backend diagnostics
        if: github.event.inputs.run_backend_diagnostics == 'true' && steps.secrets_check.outputs.can_ssh == 'true'
        id: basic_backend_diagnostics
        run: |
          echo "╔════════════════════════════════════════════════════════════════╗"
          echo "║            RUNNING BASIC BACKEND DIAGNOSTICS                   ║"
          echo "╚════════════════════════════════════════════════════════════════╝"
          echo ""
          echo "Mode: ${{ github.event.inputs.backend_mode }}"
          echo ""

          # Run diagnostics and capture fix count
          FIX_COUNT=$(ssh -i ~/.ssh/id_rsa ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            cd ${{ env.DEPLOY_DIR }}

            # Run basic diagnostics
            ./scripts/diagnose-plugins.sh ${{ github.event.inputs.backend_mode }} || true

            # Find the most recent diagnostics directory and count fixes
            DIAG_DIR=$(ls -td /tmp/plugin-diagnostics-* 2>/dev/null | grep -v advanced | head -1)

            if [ -n "$DIAG_DIR" ] && [ -f "$DIAG_DIR/fixes.log" ]; then
              wc -l < "$DIAG_DIR/fixes.log"
            else
              echo "0"
            fi
          EOF
          )

          echo "fixes_applied=$FIX_COUNT" >> $GITHUB_OUTPUT
          echo "✓ Basic diagnostics completed. Fixes applied: $FIX_COUNT"

      - name: Run advanced backend diagnostics
        if: github.event.inputs.run_backend_diagnostics == 'true' && github.event.inputs.run_advanced_backend == 'true' && steps.secrets_check.outputs.can_ssh == 'true'
        run: |
          echo "╔════════════════════════════════════════════════════════════════╗"
          echo "║           RUNNING ADVANCED BACKEND DIAGNOSTICS                 ║"
          echo "╚════════════════════════════════════════════════════════════════╝"
          echo ""

          ssh -i ~/.ssh/id_rsa ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            cd ${{ env.DEPLOY_DIR }}

            # Run advanced diagnostics
            ./scripts/diagnose-plugins-advanced.sh || true
          EOF

          echo "✓ Advanced diagnostics completed"

      - name: Backend diagnostics skipped (SSH not available)
        if: github.event.inputs.run_backend_diagnostics == 'true' && steps.secrets_check.outputs.can_ssh != 'true'
        run: |
          echo "⚠️ Backend diagnostics require SSH access to remote server"
          echo "   Missing secrets: SERVER_HOST, SERVER_USER, and/or SSH_PRIVATE_KEY"
          echo "   This step has been skipped - see final summary for how to enable"

      # ========================================================================
      # BROWSER DIAGNOSTICS - Automated browser testing
      # ========================================================================
      - name: Run browser diagnostics
        if: github.event.inputs.run_browser_diagnostics == 'true'
        env:
          CONSOLE_URL: ${{ steps.console_url.outputs.url }}
          ADMIN_USERNAME: ${{ secrets.CONSOLE_ADMIN_USER || 'admin' }}
          ADMIN_PASSWORD: ${{ secrets.CONSOLE_ADMIN_PASSWORD || 'admin' }}
          OUTPUT_DIR: /tmp/comprehensive-browser-diagnostics-${{ github.run_number }}
          HEADLESS: ${{ github.event.inputs.headless }}
          TIMEOUT: 30000
        run: |
          echo "╔════════════════════════════════════════════════════════════════╗"
          echo "║                 BROWSER DIAGNOSTICS                            ║"
          echo "╚════════════════════════════════════════════════════════════════╝"
          echo ""
          echo "Console URL: ${CONSOLE_URL}"
          echo "Headless mode: ${HEADLESS}"
          echo ""

          # Run browser diagnostics and capture exit code
          EXIT_CODE=0
          node scripts/browser-diagnostics.js || EXIT_CODE=$?

          # List generated files
          echo ""
          echo "Generated diagnostic files:"
          ls -lh /tmp/comprehensive-browser-diagnostics-${{ github.run_number }}/ || echo "No files generated"

          # Exit with error if diagnostics failed critically (exit code > 1)
          # Exit code 1 is acceptable (errors found but diagnostics completed)
          # Exit code > 1 indicates script failure
          if [ $EXIT_CODE -gt 1 ]; then
            echo "✗ Browser diagnostics failed with exit code $EXIT_CODE"
            exit $EXIT_CODE
          fi

          echo "✓ Browser diagnostics completed (exit code: $EXIT_CODE)"

      # ========================================================================
      # API PROFILING - Comprehensive API endpoint testing
      # ========================================================================
      - name: Run API profiling
        if: github.event.inputs.run_api_profiling == 'true'
        env:
          CONSOLE_URL: ${{ steps.console_url.outputs.url }}
          ADMIN_USERNAME: ${{ secrets.CONSOLE_ADMIN_USER || 'admin' }}
          ADMIN_PASSWORD: ${{ secrets.CONSOLE_ADMIN_PASSWORD || 'admin' }}
          OUTPUT_DIR: /tmp/comprehensive-api-profiler-${{ github.run_number }}
        run: |
          echo "╔════════════════════════════════════════════════════════════════╗"
          echo "║                   API PROFILING                                ║"
          echo "╚════════════════════════════════════════════════════════════════╝"
          echo ""

          chmod +x scripts/api-profiler.sh
          scripts/api-profiler.sh || true

          # List generated files
          echo ""
          echo "Generated API profiling files:"
          ls -lh /tmp/comprehensive-api-profiler-${{ github.run_number }}/ || echo "No files generated"

          echo "✓ API profiling completed"

      # ========================================================================
      # STOP RESOURCE MONITORING - Collect results
      # ========================================================================
      - name: Stop resource monitoring and download results
        if: always() && github.event.inputs.run_resource_monitoring == 'true' && steps.secrets_check.outputs.can_ssh == 'true'
        run: |
          echo "╔════════════════════════════════════════════════════════════════╗"
          echo "║          STOPPING RESOURCE MONITORING                          ║"
          echo "╚════════════════════════════════════════════════════════════════╝"
          echo ""

          # Give it a moment to finish current cycle
          sleep 5

          ssh -i ~/.ssh/id_rsa ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            # Stop monitoring if still running
            if [ -f /tmp/resource-monitor-${{ github.run_number }}.pid ]; then
              PID=$(cat /tmp/resource-monitor-${{ github.run_number }}.pid)
              if ps -p $PID > /dev/null 2>&1; then
                echo "Stopping resource monitor (PID: $PID)"
                kill $PID 2>/dev/null || true
                sleep 2
              fi
            fi

            # Create tarball if data exists
            if [ -d /tmp/comprehensive-diagnostics-resources-${{ github.run_number }} ]; then
              cd /tmp
              tar -czf comprehensive-diagnostics-resources-${{ github.run_number }}.tar.gz \
                comprehensive-diagnostics-resources-${{ github.run_number }}/
              echo "✓ Resource monitoring data archived"
            fi
          EOF

          # Download the tarball
          scp -i ~/.ssh/id_rsa \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/tmp/comprehensive-diagnostics-resources-${{ github.run_number }}.tar.gz \
            ./comprehensive-diagnostics-resources.tar.gz || echo "⚠ No resource monitoring data to download"

          # Extract if downloaded
          if [ -f ./comprehensive-diagnostics-resources.tar.gz ]; then
            mkdir -p ./diagnostics-resources
            tar -xzf ./comprehensive-diagnostics-resources.tar.gz -C ./diagnostics-resources
            echo "✓ Resource monitoring data downloaded and extracted"
          fi

      # ========================================================================
      # DOWNLOAD BACKEND DIAGNOSTICS
      # ========================================================================
      - name: Download basic backend diagnostic reports
        if: always() && github.event.inputs.run_backend_diagnostics == 'true' && steps.secrets_check.outputs.can_ssh == 'true'
        run: |
          echo "╔════════════════════════════════════════════════════════════════╗"
          echo "║         DOWNLOADING BACKEND DIAGNOSTIC REPORTS                 ║"
          echo "╚════════════════════════════════════════════════════════════════╝"
          echo ""

          ssh -i ~/.ssh/id_rsa ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            # Find most recent basic diagnostics directory
            DIAG_DIR=$(ls -td /tmp/plugin-diagnostics-* 2>/dev/null | grep -v "advanced" | head -1)

            if [ -n "$DIAG_DIR" ]; then
              # Create tarball of diagnostics
              tar -czf /tmp/plugin-diagnostics-basic-${{ github.run_number }}.tar.gz -C "$(dirname "$DIAG_DIR")" "$(basename "$DIAG_DIR")"
              echo "✓ Created basic diagnostics archive"
            else
              echo "⚠ No basic diagnostics directory found"
            fi
          EOF

          # Download the tarball
          scp -i ~/.ssh/id_rsa \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/tmp/plugin-diagnostics-basic-${{ github.run_number }}.tar.gz \
            ./plugin-diagnostics-basic.tar.gz || echo "⚠ Failed to download basic diagnostics"

          # Extract for artifact upload
          if [ -f ./plugin-diagnostics-basic.tar.gz ]; then
            mkdir -p ./diagnostics-backend-basic
            tar -xzf ./plugin-diagnostics-basic.tar.gz -C ./diagnostics-backend-basic
            echo "✓ Basic backend diagnostics downloaded"
          fi

      - name: Download advanced backend diagnostic reports
        if: always() && github.event.inputs.run_backend_diagnostics == 'true' && github.event.inputs.run_advanced_backend == 'true' && steps.secrets_check.outputs.can_ssh == 'true'
        run: |
          echo "Downloading advanced backend diagnostic reports..."

          ssh -i ~/.ssh/id_rsa ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            # Find most recent advanced diagnostics directory
            ADV_DIAG_DIR=$(ls -td /tmp/plugin-diagnostics-advanced-* 2>/dev/null | head -1)

            if [ -n "$ADV_DIAG_DIR" ]; then
              # Create tarball of diagnostics
              tar -czf /tmp/plugin-diagnostics-advanced-${{ github.run_number }}.tar.gz -C "$(dirname "$ADV_DIAG_DIR")" "$(basename "$ADV_DIAG_DIR")"
              echo "✓ Created advanced diagnostics archive"
            else
              echo "⚠ No advanced diagnostics directory found"
            fi
          EOF

          # Download the tarball
          scp -i ~/.ssh/id_rsa \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/tmp/plugin-diagnostics-advanced-${{ github.run_number }}.tar.gz \
            ./plugin-diagnostics-advanced.tar.gz || echo "⚠ Failed to download advanced diagnostics"

          # Extract for artifact upload
          if [ -f ./plugin-diagnostics-advanced.tar.gz ]; then
            mkdir -p ./diagnostics-backend-advanced
            tar -xzf ./plugin-diagnostics-advanced.tar.gz -C ./diagnostics-backend-advanced
            echo "✓ Advanced backend diagnostics downloaded"
          fi

      # ========================================================================
      # MASTER AGGREGATION AND SUMMARY
      # ========================================================================
      - name: Capture timestamp
        id: timestamp
        run: echo "timestamp=$(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT

      - name: Generate comprehensive master summary
        if: always()
        env:
          OUTPUT_DIR: ./comprehensive-summary
          BROWSER_DIAGNOSTICS_DIR: /tmp/comprehensive-browser-diagnostics-${{ github.run_number }}
          API_PROFILER_DIR: /tmp/comprehensive-api-profiler-${{ github.run_number }}
          BACKEND_BASIC_DIR: ./diagnostics-backend-basic
          BACKEND_ADVANCED_DIR: ./diagnostics-backend-advanced
          RESOURCES_DIR: ./diagnostics-resources
          RUN_NUMBER: ${{ github.run_number }}
          CONSOLE_URL: ${{ steps.console_url.outputs.url }}
          TIMESTAMP: ${{ steps.timestamp.outputs.timestamp }}
          RUN_BROWSER_DIAGNOSTICS: ${{ github.event.inputs.run_browser_diagnostics }}
          RUN_BACKEND_DIAGNOSTICS: ${{ github.event.inputs.run_backend_diagnostics }}
          RUN_ADVANCED_BACKEND: ${{ github.event.inputs.run_advanced_backend }}
          RUN_API_PROFILING: ${{ github.event.inputs.run_api_profiling }}
          RUN_RESOURCE_MONITORING: ${{ github.event.inputs.run_resource_monitoring }}
          BACKEND_MODE: ${{ github.event.inputs.backend_mode }}
          MONITOR_DURATION: ${{ github.event.inputs.monitor_duration }}
          MONITOR_INTERVAL: ${{ github.event.inputs.monitor_interval }}
          HAS_SERVER_HOST: ${{ steps.secrets_check.outputs.has_server_host }}
          HAS_SERVER_USER: ${{ steps.secrets_check.outputs.has_server_user }}
          HAS_SSH_KEY: ${{ steps.secrets_check.outputs.has_ssh_key }}
          HAS_CONSOLE_USER: ${{ steps.secrets_check.outputs.has_console_user }}
          HAS_CONSOLE_PASS: ${{ steps.secrets_check.outputs.has_console_pass }}
          CAN_SSH: ${{ steps.secrets_check.outputs.can_ssh }}
        run: |
          echo "╔════════════════════════════════════════════════════════════════╗"
          echo "║           GENERATING MASTER SUMMARY                            ║"
          echo "╚════════════════════════════════════════════════════════════════╝"
          echo ""

          # Make script executable and run it
          chmod +x scripts/generate-diagnostics-summary.sh
          if ! scripts/generate-diagnostics-summary.sh; then
            echo "⚠️  Warning: Summary generation encountered errors"
            echo "This may indicate missing diagnostic data, which is expected if some diagnostics were skipped"
            echo "Attempting to continue with available data..."
            # Still try to display what was generated
            [ -f ./comprehensive-summary/MASTER-SUMMARY.txt ] && cat ./comprehensive-summary/MASTER-SUMMARY.txt || echo "No summary file generated"
          fi

          echo ""
          echo "✓ Master summary generated successfully"
          echo ""
          echo "Displaying summary:"
          cat ./comprehensive-summary/MASTER-SUMMARY.txt

      # ========================================================================
      # UPLOAD ARTIFACTS
      # ========================================================================
      - name: Upload browser diagnostics artifact
        uses: actions/upload-artifact@v4
        if: always() && github.event.inputs.run_browser_diagnostics == 'true'
        with:
          name: browser-diagnostics-${{ github.run_number }}
          path: /tmp/comprehensive-browser-diagnostics-${{ github.run_number }}/
          retention-days: 30
          if-no-files-found: warn

      - name: Upload backend basic diagnostics artifact
        uses: actions/upload-artifact@v4
        if: always() && github.event.inputs.run_backend_diagnostics == 'true'
        with:
          name: backend-diagnostics-basic-${{ github.run_number }}
          path: diagnostics-backend-basic/
          retention-days: 30
          if-no-files-found: warn

      - name: Upload backend advanced diagnostics artifact
        uses: actions/upload-artifact@v4
        if: always() && github.event.inputs.run_backend_diagnostics == 'true' && github.event.inputs.run_advanced_backend == 'true'
        with:
          name: backend-diagnostics-advanced-${{ github.run_number }}
          path: diagnostics-backend-advanced/
          retention-days: 30
          if-no-files-found: warn

      - name: Upload API profiling artifact
        uses: actions/upload-artifact@v4
        if: always() && github.event.inputs.run_api_profiling == 'true'
        with:
          name: api-profiling-${{ github.run_number }}
          path: /tmp/comprehensive-api-profiler-${{ github.run_number }}/
          retention-days: 30
          if-no-files-found: warn

      - name: Upload resource monitoring artifact
        uses: actions/upload-artifact@v4
        if: always() && github.event.inputs.run_resource_monitoring == 'true'
        with:
          name: resource-monitoring-${{ github.run_number }}
          path: ./diagnostics-resources/
          retention-days: 30
          if-no-files-found: warn

      - name: Upload comprehensive summary artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: comprehensive-summary-${{ github.run_number }}
          path: ./comprehensive-summary/
          retention-days: 30
          if-no-files-found: warn

      # ========================================================================
      # DISPLAY SUMMARY IN WORKFLOW
      # ========================================================================
      - name: Display summary in workflow
        if: always()
        run: |
          if [ -f ./comprehensive-summary/README.md ]; then
            cat ./comprehensive-summary/README.md >> $GITHUB_STEP_SUMMARY
          fi

      # ========================================================================
      # CLEANUP
      # ========================================================================
      - name: Cleanup server files
        if: always() && steps.secrets_check.outputs.can_ssh == 'true'
        run: |
          echo "╔════════════════════════════════════════════════════════════════╗"
          echo "║                    CLEANUP                                     ║"
          echo "╚════════════════════════════════════════════════════════════════╝"
          echo ""

          ssh -i ~/.ssh/id_rsa ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF' || true
            # Remove temporary files from this run
            rm -f /tmp/resource-monitor-${{ github.run_number }}.pid
            rm -f /tmp/resource-monitor-${{ github.run_number }}.log
            rm -f /tmp/comprehensive-diagnostics-resources-${{ github.run_number }}.tar.gz
            rm -rf /tmp/comprehensive-diagnostics-resources-${{ github.run_number }}
            rm -f /tmp/plugin-diagnostics-basic-${{ github.run_number }}.tar.gz
            rm -f /tmp/plugin-diagnostics-advanced-${{ github.run_number }}.tar.gz

            # Keep diagnostic directories for 7 days, clean up older ones
            find /tmp -maxdepth 1 -name "plugin-diagnostics-*" -type d -mtime +7 -exec rm -rf {} \; 2>/dev/null || true
            find /tmp -maxdepth 1 -name "comprehensive-diagnostics-resources-*" -type d -mtime +7 -exec rm -rf {} \; 2>/dev/null || true

            echo "✓ Cleanup complete"
          EOF
