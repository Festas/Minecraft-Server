name: Reset Console Password

'on':
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "RESET" to confirm you want to reset the console password'
        required: true
        type: string

jobs:
  reset-password:
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == 'RESET'
    permissions:
      contents: read

    steps:
      - name: Validate confirmation
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "RESET" ]; then
            echo "::error::You must type RESET to confirm this action"
            exit 1
          fi
          echo "âœ“ Confirmation received"

      - name: Reset console password on server
        uses: appleboy/ssh-action@v1.2.4
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e

            DEPLOY_DIR="/home/deploy/minecraft-console"

            echo "=== Resetting Console Password ==="
            echo ""

            cd "$DEPLOY_DIR"

            # Stop the console container
            echo "Stopping console container..."
            docker compose down || true

            # Remove the config volume to clear users.json
            echo "Removing config volume..."
            docker volume rm minecraft-console_console_config 2>/dev/null || \
              echo "Volume not found, continuing..."

            # Restart the console
            echo "Starting console container..."
            docker compose up -d

            # Wait for container to be healthy
            echo "Waiting for console to be healthy..."
            for i in {1..30}; do
              HEALTH=$(docker inspect --format='{{.State.Health.Status}}' \
                minecraft-console 2>/dev/null || echo "starting")
              if [ "$HEALTH" = "healthy" ]; then
                echo "âœ“ Console is healthy"
                break
              fi
              echo "  Status: $HEALTH (attempt $i/30)"
              sleep 2
            done

            # Show logs to confirm user creation
            echo ""
            echo "=== Console Logs ==="
            docker logs minecraft-console 2>&1 | \
              grep -i "user\|admin\|password\|created\|error" | head -20 || \
              echo "No relevant logs found"

            echo ""
            echo "âœ“ Password reset complete!"
            echo "You can now login with your CONSOLE_ADMIN_USER and" \
              "CONSOLE_ADMIN_PASSWORD from GitHub Secrets"

      - name: Summary
        run: |
          {
            echo "## Console Password Reset Complete! ðŸ”"
            echo ""
            echo "The console user data has been cleared and regenerated."
            echo ""
            echo "**Next Steps:**"
            echo "1. Go to https://mc.festas-builds.com/console"
            echo "2. Login with your credentials from GitHub Secrets:"
            echo "   - Username: Value of \`CONSOLE_ADMIN_USER\` secret"
            echo "   - Password: Value of \`CONSOLE_ADMIN_PASSWORD\` secret"
            echo ""
            echo "If login still fails, check the container logs in the" \
              "workflow output above."
          } >> "$GITHUB_STEP_SUMMARY"

  rejected:
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm != 'RESET'
    permissions:
      contents: read
    steps:
      - name: Action rejected
        run: |
          echo "::error::Password reset was not confirmed. You must type 'RESET' to proceed."
          exit 1
